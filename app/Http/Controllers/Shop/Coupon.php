<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp0fc69c) { $sp3c5594 = (int) $sp0fc69c->post('category_id', -1); $spedd229 = (int) $sp0fc69c->post('product_id', -1); $sp08578a = $sp0fc69c->post('coupon'); if (!$sp08578a) { return Response::fail('请输入优惠券'); } if ($sp3c5594 > 0) { $sp67f4a3 = Category::findOrFail($sp3c5594); $sp5670aa = $sp67f4a3->user_id; } elseif ($spedd229 > 0) { $spcf7f28 = Product::findOrFail($spedd229); $sp5670aa = $spcf7f28->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp144bbf = \App\Coupon::where('user_id', $sp5670aa)->where('coupon', $sp08578a)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp144bbf as $sp08578a) { if ($sp08578a->category_id === -1 || $sp08578a->category_id === $sp3c5594 && ($sp08578a->product_id === -1 || $sp08578a->product_id === $spedd229)) { $sp08578a->setVisible(array('discount_type', 'discount_val')); return Response::success($sp08578a); } } return Response::fail('优惠券信息无效'); } }