<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp85ba11) { $sp7bb93d = (int) $sp85ba11->post('category_id', -1); $sp16cfd7 = (int) $sp85ba11->post('product_id', -1); $spba1aa5 = $sp85ba11->post('coupon'); if (!$spba1aa5) { return Response::fail('请输入优惠券'); } if ($sp7bb93d > 0) { $sp9a35dc = Category::findOrFail($sp7bb93d); $spaef809 = $sp9a35dc->user_id; } elseif ($sp16cfd7 > 0) { $spf85ebf = Product::findOrFail($sp16cfd7); $spaef809 = $spf85ebf->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp2b6ed8 = \App\Coupon::where('user_id', $spaef809)->where('coupon', $spba1aa5)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp2b6ed8 as $spba1aa5) { if ($spba1aa5->category_id === -1 || $spba1aa5->category_id === $sp7bb93d && ($spba1aa5->product_id === -1 || $spba1aa5->product_id === $sp16cfd7)) { $spba1aa5->setVisible(array('discount_type', 'discount_val')); return Response::success($spba1aa5); } } return Response::fail('优惠券信息无效'); } }