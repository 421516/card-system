<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp845342) { $sp68f2fa = (int) $sp845342->post('category_id', -1); $sp3c4c73 = (int) $sp845342->post('product_id', -1); $sp05f0f3 = $sp845342->post('coupon'); if (!$sp05f0f3) { return Response::fail('请输入优惠券'); } if ($sp68f2fa > 0) { $sp6680bb = Category::findOrFail($sp68f2fa); $spfedf4e = $sp6680bb->user_id; } elseif ($sp3c4c73 > 0) { $sp41d615 = Product::findOrFail($sp3c4c73); $spfedf4e = $sp41d615->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp79854d = \App\Coupon::where('user_id', $spfedf4e)->where('coupon', $sp05f0f3)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp79854d as $sp05f0f3) { if ($sp05f0f3->category_id === -1 || $sp05f0f3->category_id === $sp68f2fa && ($sp05f0f3->product_id === -1 || $sp05f0f3->product_id === $sp3c4c73)) { $sp05f0f3->setVisible(array('discount_type', 'discount_val')); return Response::success($sp05f0f3); } } return Response::fail('优惠券信息无效'); } }