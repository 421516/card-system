<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $sp2d83a6) { $spd8dba1 = (int) $sp2d83a6->post('category_id', -1); $spd09702 = (int) $sp2d83a6->post('product_id', -1); $sp36c873 = $sp2d83a6->post('coupon'); if (!$sp36c873) { return Response::fail('请输入优惠券'); } if ($spd8dba1 > 0) { $sp58b2cb = Category::findOrFail($spd8dba1); $spc52aea = $sp58b2cb->user_id; } elseif ($spd09702 > 0) { $spb0ecc4 = Product::findOrFail($spd09702); $spc52aea = $spb0ecc4->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp8f11d6 = \App\Coupon::where('user_id', $spc52aea)->where('coupon', $sp36c873)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp8f11d6 as $sp36c873) { if ($sp36c873->category_id === -1 || $sp36c873->category_id === $spd8dba1 && ($sp36c873->product_id === -1 || $sp36c873->product_id === $spd09702)) { $sp36c873->setVisible(array('discount_type', 'discount_val')); return Response::success($sp36c873); } } return Response::fail('优惠券信息无效'); } }