<?php
namespace App\Http\Controllers\Shop; use App\Category; use App\Product; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function info(Request $spdd9f33) { $sp4a6190 = (int) $spdd9f33->post('category_id', -1); $spfafc60 = (int) $spdd9f33->post('product_id', -1); $spe017d6 = $spdd9f33->post('coupon'); if (!$spe017d6) { return Response::fail('请输入优惠券'); } if ($sp4a6190 > 0) { $sp8d0209 = Category::findOrFail($sp4a6190); $spc7622d = $sp8d0209->user_id; } elseif ($spfafc60 > 0) { $sp32da29 = Product::findOrFail($spfafc60); $spc7622d = $sp32da29->user_id; } else { return Response::fail('请先选择分类或商品'); } $sp2130e7 = \App\Coupon::where('user_id', $spc7622d)->where('coupon', $spe017d6)->where('expire_at', '>', Carbon::now())->whereRaw('`count_used`<`count_all`')->get(); foreach ($sp2130e7 as $spe017d6) { if ($spe017d6->category_id === -1 || $spe017d6->category_id === $sp4a6190 && ($spe017d6->product_id === -1 || $spe017d6->product_id === $spfafc60)) { $spe017d6->setVisible(array('discount_type', 'discount_val')); return Response::success($spe017d6); } } return Response::fail('优惠券信息无效'); } }