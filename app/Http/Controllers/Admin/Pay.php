<?php
namespace App\Http\Controllers\Admin; use App\Library\Helper; use function foo\func; use Illuminate\Http\Request; use App\Http\Controllers\Controller; use App\Library\Response; class Pay extends Controller { function get(Request $sp845342) { $sp3eff46 = \App\Pay::orderBy('sort'); $spd36004 = $sp845342->post('enabled'); if (strlen($spd36004)) { $sp3eff46->whereIn('enabled', explode(',', $spd36004)); } $sp9d8b43 = $sp845342->post('search', false); if ($sp9d8b43 == 'simple') { return Response::success($sp3eff46->get(array('id', 'name'))); } $spd1b01a = $sp3eff46->get(); return Response::success($spd1b01a); } function stat(Request $sp845342) { $sp071519 = (int) $sp845342->input('day', 7); $spd1b01a = \App\Order::where(function ($sp3eff46) { $sp3eff46->where('status', \App\Order::STATUS_PAID)->orWhere('status', \App\Order::STATUS_SUCCESS); })->where('paid_at', '>=', Helper::getMysqlDate(-$sp071519 + 1))->with(array('pay' => function ($sp3eff46) { $sp3eff46->select(array('id', 'name')); }))->groupBy('pay_id')->selectRaw('`pay_id`,COUNT(*) as "count",SUM(`paid`) as "sum"')->get()->toArray(); $spec9b7c = array(); foreach ($spd1b01a as $spb18bb2) { if (isset($spb18bb2['pay']) && isset($spb18bb2['pay']['name'])) { $sp41a1aa = $spb18bb2['pay']['name']; } else { $sp41a1aa = '未知方式#' . $spb18bb2['pay_id']; } $spec9b7c[$sp41a1aa] = array((int) $spb18bb2['count'], (int) $spb18bb2['sum']); } return Response::success($spec9b7c); } function edit(Request $sp845342) { $this->validate($sp845342, array('id' => 'required|integer', 'name' => 'required|string', 'img' => 'required|string', 'driver' => 'required|string', 'way' => 'required|string', 'config' => 'required|string')); $sp3a2be3 = (int) $sp845342->post('id'); $spe51eb0 = $sp845342->post('name'); $spdd541b = $sp845342->post('img'); $sp0f6d64 = $sp845342->post('comment'); $spcda0d1 = $sp845342->post('driver'); $sp2a5094 = $sp845342->post('way'); $sp45b2a0 = $sp845342->post('config'); $spd36004 = (int) $sp845342->post('enabled'); $sp14dff9 = \App\Pay::find($sp3a2be3); if (!$sp14dff9) { $sp14dff9 = new \App\Pay(); } $sp14dff9->name = $spe51eb0; $sp14dff9->img = $spdd541b; $sp14dff9->comment = $sp0f6d64; $sp14dff9->driver = $spcda0d1; $sp14dff9->way = $sp2a5094; $sp14dff9->config = $sp45b2a0; $sp14dff9->enabled = $spd36004; $sp14dff9->fee_system = $sp845342->post('fee_system'); $sp14dff9->saveOrFail(); return Response::success(); } function comment(Request $sp845342) { $sp3a2be3 = (int) $sp845342->post('id', -1); if (!$sp3a2be3) { return Response::forbidden(); } $sp14dff9 = \App\Pay::findOrFail($sp3a2be3); $sp14dff9->comment = $sp845342->post('comment'); $sp14dff9->save(); return Response::success(); } function sort(Request $sp845342) { $sp3a2be3 = (int) $sp845342->post('id', -1); if (!$sp3a2be3) { return Response::forbidden(); } $sp14dff9 = \App\Pay::findOrFail($sp3a2be3); $sp14dff9->sort = (int) $sp845342->post('sort', 1000); $sp14dff9->save(); return Response::success(); } function fee_system(Request $sp845342) { $sp3a2be3 = (int) $sp845342->post('id'); if ($sp3a2be3 < 1) { return Response::forbidden(); } $sp14dff9 = \App\Pay::findOrFail($sp3a2be3); $sp14dff9->fee_system = $sp845342->post('fee_system'); $sp14dff9->saveOrFail(); return Response::success(); } function enable(Request $sp845342) { $sp35201d = $sp845342->post('ids'); if (strlen($sp35201d) < 1) { return Response::forbidden(); } $spd36004 = (int) $sp845342->post('enabled'); \App\Pay::whereIn('id', explode(',', $sp35201d))->update(array('enabled' => $spd36004)); return Response::success(); } function delete(Request $sp845342) { $sp3a2be3 = (int) $sp845342->post('id'); if ($sp3a2be3 < 1) { return Response::forbidden(); } \App\Pay::whereId($sp3a2be3)->delete(); return Response::success(); } }