<?php
namespace App\Http\Controllers\Merchant; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function get(Request $sp2d83a6) { $spedc15a = $this->authQuery($sp2d83a6, \App\Coupon::class)->with(array('category' => function ($spedc15a) { $spedc15a->select(array('id', 'name')); }))->with(array('product' => function ($spedc15a) { $spedc15a->select(array('id', 'name')); })); $sp53975f = $sp2d83a6->post('search', false); $spffa78a = $sp2d83a6->post('val', false); if ($sp53975f && $spffa78a) { if ($sp53975f == 'id') { $spedc15a->where('id', $spffa78a); } else { $spedc15a->where($sp53975f, 'like', '%' . $spffa78a . '%'); } } $spd8dba1 = (int) $sp2d83a6->post('category_id'); $spd09702 = $sp2d83a6->post('product_id', -1); if ($spd8dba1 > 0) { if ($spd09702 > 0) { $spedc15a->where('product_id', $spd09702); } else { $spedc15a->where('category_id', $spd8dba1); } } $spd4997e = $sp2d83a6->post('status'); if (strlen($spd4997e)) { $spedc15a->whereIn('status', explode(',', $spd4997e)); } $spcbde7f = $sp2d83a6->post('type'); if (strlen($spcbde7f)) { $spedc15a->whereIn('type', explode(',', $spcbde7f)); } $spedc15a->orderByRaw('expire_at DESC,category_id,product_id,type,status'); $sp9ca635 = $sp2d83a6->post('current_page', 1); $spb53279 = $sp2d83a6->post('per_page', 20); $sp8ea0e0 = $spedc15a->paginate($spb53279, array('*'), 'page', $sp9ca635); return Response::success($sp8ea0e0); } function create(Request $sp2d83a6) { $sp93b866 = $sp2d83a6->post('count', 0); $spcbde7f = (int) $sp2d83a6->post('type', \App\Coupon::TYPE_ONETIME); $sp7210b5 = $sp2d83a6->post('expire_at'); $sp762353 = (int) $sp2d83a6->post('discount_val'); $sp3d72a1 = (int) $sp2d83a6->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); $spcdf302 = $sp2d83a6->post('remark'); if ($sp3d72a1 === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($sp762353 < 1 || $sp762353 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp3d72a1 === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($sp762353 < 1 || $sp762353 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $spd8dba1 = (int) $sp2d83a6->post('category_id', -1); $spd09702 = (int) $sp2d83a6->post('product_id', -1); if ($spcbde7f === \App\Coupon::TYPE_REPEAT) { $sp36c873 = $sp2d83a6->post('coupon'); if (!$sp36c873) { $sp36c873 = strtoupper(str_random()); } $sp1c59c9 = new \App\Coupon(); $sp1c59c9->user_id = $this->getUserIdOrFail($sp2d83a6); $sp1c59c9->category_id = $spd8dba1; $sp1c59c9->product_id = $spd09702; $sp1c59c9->coupon = $sp36c873; $sp1c59c9->type = $spcbde7f; $sp1c59c9->discount_val = $sp762353; $sp1c59c9->discount_type = $sp3d72a1; $sp1c59c9->count_all = (int) $sp2d83a6->post('count_all', 1); if ($sp1c59c9->count_all < 1 || $sp1c59c9->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } $sp1c59c9->expire_at = $sp7210b5; $sp1c59c9->saveOrFail(); return Response::success(array($sp1c59c9->coupon)); } elseif ($spcbde7f === \App\Coupon::TYPE_ONETIME) { if (!$sp93b866) { return Response::forbidden('请输入生成数量'); } if ($sp93b866 > 100) { return Response::forbidden('每次生成不能大于100张'); } $sp8f11d6 = array(); $spdfb7a3 = array(); $spc52aea = $this->getUserIdOrFail($sp2d83a6); $sp3988c7 = Carbon::now(); for ($spcecaa9 = 0; $spcecaa9 < $sp93b866; $spcecaa9++) { $sp1c59c9 = strtoupper(str_random()); $spdfb7a3[] = $sp1c59c9; $sp8f11d6[] = array('user_id' => $spc52aea, 'coupon' => $sp1c59c9, 'category_id' => $spd8dba1, 'product_id' => $spd09702, 'type' => $spcbde7f, 'discount_val' => $sp762353, 'discount_type' => $sp3d72a1, 'status' => \App\Coupon::STATUS_NORMAL, 'remark' => $spcdf302, 'created_at' => $sp3988c7, 'expire_at' => $sp7210b5); } \App\Coupon::insert($sp8f11d6); return Response::success($spdfb7a3); } else { return Response::forbidden('unknown type: ' . $spcbde7f); } } function edit(Request $sp2d83a6) { $spe6149b = (int) $sp2d83a6->post('id'); $sp36c873 = $sp2d83a6->post('coupon'); $spd8dba1 = (int) $sp2d83a6->post('category_id', -1); $spd09702 = (int) $sp2d83a6->post('product_id', -1); $sp7210b5 = $sp2d83a6->post('expire_at', NULL); $spd4997e = (int) $sp2d83a6->post('status', \App\Coupon::STATUS_NORMAL); $spcbde7f = (int) $sp2d83a6->post('type', \App\Coupon::TYPE_ONETIME); $sp762353 = (int) $sp2d83a6->post('discount_val'); $sp3d72a1 = (int) $sp2d83a6->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); if ($sp3d72a1 === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($sp762353 < 1 || $sp762353 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp3d72a1 === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($sp762353 < 1 || $sp762353 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $sp1c59c9 = $this->authQuery($sp2d83a6, \App\Coupon::class)->find($spe6149b); if ($sp1c59c9) { $sp1c59c9->coupon = $sp36c873; $sp1c59c9->category_id = $spd8dba1; $sp1c59c9->product_id = $spd09702; $sp1c59c9->status = $spd4997e; $sp1c59c9->type = $spcbde7f; $sp1c59c9->discount_val = $sp762353; $sp1c59c9->discount_type = $sp3d72a1; if ($spcbde7f === \App\Coupon::TYPE_REPEAT) { $sp1c59c9->count_all = (int) $sp2d83a6->post('count_all', 1); if ($sp1c59c9->count_all < 1 || $sp1c59c9->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } } if ($sp7210b5) { $sp1c59c9->expire_at = $sp7210b5; } $sp1c59c9->saveOrFail(); } else { $sp3f036a = explode('
', $sp36c873); for ($spcecaa9 = 0; $spcecaa9 < count($sp3f036a); $spcecaa9++) { $sp0f893d = str_replace('', '', trim($sp3f036a[$spcecaa9])); $sp1c59c9 = new \App\Coupon(); $sp1c59c9->coupon = $sp0f893d; $sp1c59c9->category_id = $spd8dba1; $sp1c59c9->product_id = $spd09702; $sp1c59c9->status = $spd4997e; $sp1c59c9->type = $spcbde7f; $sp1c59c9->discount_val = $sp762353; $sp1c59c9->discount_type = $sp3d72a1; $sp3f036a[$spcecaa9] = $sp1c59c9; } \App\Product::find($spd09702)->coupons()->saveMany($sp3f036a); } return Response::success(); } function enable(Request $sp2d83a6) { $sp1b3f11 = $sp2d83a6->post('ids', ''); if (strlen($sp1b3f11) < 1) { return Response::forbidden(); } $spedd1cd = (int) $sp2d83a6->post('enabled'); $this->authQuery($sp2d83a6, \App\Coupon::class)->whereIn('id', explode(',', $sp1b3f11))->update(array('enabled' => $spedd1cd)); return Response::success(); } function delete(Request $sp2d83a6) { $sp1b3f11 = $sp2d83a6->post('ids', ''); if (strlen($sp1b3f11) < 1) { return Response::forbidden(); } $this->authQuery($sp2d83a6, \App\Coupon::class)->whereIn('id', explode(',', $sp1b3f11))->delete(); return Response::success(); } }