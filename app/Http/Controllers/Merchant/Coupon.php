<?php
namespace App\Http\Controllers\Merchant; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function get(Request $sp845342) { $sp3eff46 = $this->authQuery($sp845342, \App\Coupon::class)->with(array('category' => function ($sp3eff46) { $sp3eff46->select(array('id', 'name')); }))->with(array('product' => function ($sp3eff46) { $sp3eff46->select(array('id', 'name')); })); $sp9d8b43 = $sp845342->post('search', false); $sp752740 = $sp845342->post('val', false); if ($sp9d8b43 && $sp752740) { if ($sp9d8b43 == 'id') { $sp3eff46->where('id', $sp752740); } else { $sp3eff46->where($sp9d8b43, 'like', '%' . $sp752740 . '%'); } } $sp68f2fa = (int) $sp845342->post('category_id'); $sp3c4c73 = $sp845342->post('product_id', -1); if ($sp68f2fa > 0) { if ($sp3c4c73 > 0) { $sp3eff46->where('product_id', $sp3c4c73); } else { $sp3eff46->where('category_id', $sp68f2fa); } } $sp406289 = $sp845342->post('status'); if (strlen($sp406289)) { $sp3eff46->whereIn('status', explode(',', $sp406289)); } $sp0eab44 = $sp845342->post('type'); if (strlen($sp0eab44)) { $sp3eff46->whereIn('type', explode(',', $sp0eab44)); } $sp3eff46->orderByRaw('expire_at DESC,category_id,product_id,type,status'); $sp2d1093 = $sp845342->post('current_page', 1); $spfe0c85 = $sp845342->post('per_page', 20); $spd1b01a = $sp3eff46->paginate($spfe0c85, array('*'), 'page', $sp2d1093); return Response::success($spd1b01a); } function create(Request $sp845342) { $spda0d90 = $sp845342->post('count', 0); $sp0eab44 = (int) $sp845342->post('type', \App\Coupon::TYPE_ONETIME); $sp3b5e57 = $sp845342->post('expire_at'); $sp8cdea0 = (int) $sp845342->post('discount_val'); $sp55ac56 = (int) $sp845342->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); $sp22de17 = $sp845342->post('remark'); if ($sp55ac56 === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($sp8cdea0 < 1 || $sp8cdea0 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp55ac56 === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($sp8cdea0 < 1 || $sp8cdea0 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $sp68f2fa = (int) $sp845342->post('category_id', -1); $sp3c4c73 = (int) $sp845342->post('product_id', -1); if ($sp0eab44 === \App\Coupon::TYPE_REPEAT) { $sp05f0f3 = $sp845342->post('coupon'); if (!$sp05f0f3) { $sp05f0f3 = strtoupper(str_random()); } $sp994dfa = new \App\Coupon(); $sp994dfa->user_id = $this->getUserIdOrFail($sp845342); $sp994dfa->category_id = $sp68f2fa; $sp994dfa->product_id = $sp3c4c73; $sp994dfa->coupon = $sp05f0f3; $sp994dfa->type = $sp0eab44; $sp994dfa->discount_val = $sp8cdea0; $sp994dfa->discount_type = $sp55ac56; $sp994dfa->count_all = (int) $sp845342->post('count_all', 1); if ($sp994dfa->count_all < 1 || $sp994dfa->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } $sp994dfa->expire_at = $sp3b5e57; $sp994dfa->saveOrFail(); return Response::success(array($sp994dfa->coupon)); } elseif ($sp0eab44 === \App\Coupon::TYPE_ONETIME) { if (!$spda0d90) { return Response::forbidden('请输入生成数量'); } if ($spda0d90 > 100) { return Response::forbidden('每次生成不能大于100张'); } $sp79854d = array(); $sp20be8e = array(); $spfedf4e = $this->getUserIdOrFail($sp845342); $sp23a7e2 = Carbon::now(); for ($sp836a84 = 0; $sp836a84 < $spda0d90; $sp836a84++) { $sp994dfa = strtoupper(str_random()); $sp20be8e[] = $sp994dfa; $sp79854d[] = array('user_id' => $spfedf4e, 'coupon' => $sp994dfa, 'category_id' => $sp68f2fa, 'product_id' => $sp3c4c73, 'type' => $sp0eab44, 'discount_val' => $sp8cdea0, 'discount_type' => $sp55ac56, 'status' => \App\Coupon::STATUS_NORMAL, 'remark' => $sp22de17, 'created_at' => $sp23a7e2, 'expire_at' => $sp3b5e57); } \App\Coupon::insert($sp79854d); return Response::success($sp20be8e); } else { return Response::forbidden('unknown type: ' . $sp0eab44); } } function edit(Request $sp845342) { $sp3a2be3 = (int) $sp845342->post('id'); $sp05f0f3 = $sp845342->post('coupon'); $sp68f2fa = (int) $sp845342->post('category_id', -1); $sp3c4c73 = (int) $sp845342->post('product_id', -1); $sp3b5e57 = $sp845342->post('expire_at', NULL); $sp406289 = (int) $sp845342->post('status', \App\Coupon::STATUS_NORMAL); $sp0eab44 = (int) $sp845342->post('type', \App\Coupon::TYPE_ONETIME); $sp8cdea0 = (int) $sp845342->post('discount_val'); $sp55ac56 = (int) $sp845342->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); if ($sp55ac56 === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($sp8cdea0 < 1 || $sp8cdea0 > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp55ac56 === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($sp8cdea0 < 1 || $sp8cdea0 > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $sp994dfa = $this->authQuery($sp845342, \App\Coupon::class)->find($sp3a2be3); if ($sp994dfa) { $sp994dfa->coupon = $sp05f0f3; $sp994dfa->category_id = $sp68f2fa; $sp994dfa->product_id = $sp3c4c73; $sp994dfa->status = $sp406289; $sp994dfa->type = $sp0eab44; $sp994dfa->discount_val = $sp8cdea0; $sp994dfa->discount_type = $sp55ac56; if ($sp0eab44 === \App\Coupon::TYPE_REPEAT) { $sp994dfa->count_all = (int) $sp845342->post('count_all', 1); if ($sp994dfa->count_all < 1 || $sp994dfa->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } } if ($sp3b5e57) { $sp994dfa->expire_at = $sp3b5e57; } $sp994dfa->saveOrFail(); } else { $sp6513d6 = explode('
', $sp05f0f3); for ($sp836a84 = 0; $sp836a84 < count($sp6513d6); $sp836a84++) { $sp155ef4 = str_replace('', '', trim($sp6513d6[$sp836a84])); $sp994dfa = new \App\Coupon(); $sp994dfa->coupon = $sp155ef4; $sp994dfa->category_id = $sp68f2fa; $sp994dfa->product_id = $sp3c4c73; $sp994dfa->status = $sp406289; $sp994dfa->type = $sp0eab44; $sp994dfa->discount_val = $sp8cdea0; $sp994dfa->discount_type = $sp55ac56; $sp6513d6[$sp836a84] = $sp994dfa; } \App\Product::find($sp3c4c73)->coupons()->saveMany($sp6513d6); } return Response::success(); } function enable(Request $sp845342) { $sp35201d = $sp845342->post('ids', ''); if (strlen($sp35201d) < 1) { return Response::forbidden(); } $spd36004 = (int) $sp845342->post('enabled'); $this->authQuery($sp845342, \App\Coupon::class)->whereIn('id', explode(',', $sp35201d))->update(array('enabled' => $spd36004)); return Response::success(); } function delete(Request $sp845342) { $sp35201d = $sp845342->post('ids', ''); if (strlen($sp35201d) < 1) { return Response::forbidden(); } $this->authQuery($sp845342, \App\Coupon::class)->whereIn('id', explode(',', $sp35201d))->delete(); return Response::success(); } }