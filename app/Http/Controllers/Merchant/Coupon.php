<?php
namespace App\Http\Controllers\Merchant; use App\Library\Response; use Carbon\Carbon; use Illuminate\Http\Request; use App\Http\Controllers\Controller; class Coupon extends Controller { function get(Request $spdd9f33) { $sp26c3c2 = $this->authQuery($spdd9f33, \App\Coupon::class)->with(array('category' => function ($sp26c3c2) { $sp26c3c2->select(array('id', 'name')); }))->with(array('product' => function ($sp26c3c2) { $sp26c3c2->select(array('id', 'name')); })); $sp282adb = $spdd9f33->post('search', false); $spb80b3f = $spdd9f33->post('val', false); if ($sp282adb && $spb80b3f) { if ($sp282adb == 'id') { $sp26c3c2->where('id', $spb80b3f); } else { $sp26c3c2->where($sp282adb, 'like', '%' . $spb80b3f . '%'); } } $sp4a6190 = (int) $spdd9f33->post('category_id'); $spfafc60 = $spdd9f33->post('product_id', -1); if ($sp4a6190 > 0) { if ($spfafc60 > 0) { $sp26c3c2->where('product_id', $spfafc60); } else { $sp26c3c2->where('category_id', $sp4a6190); } } $spb55c72 = $spdd9f33->post('status'); if (strlen($spb55c72)) { $sp26c3c2->whereIn('status', explode(',', $spb55c72)); } $sp9d3dc0 = $spdd9f33->post('type'); if (strlen($sp9d3dc0)) { $sp26c3c2->whereIn('type', explode(',', $sp9d3dc0)); } $sp26c3c2->orderByRaw('expire_at DESC,category_id,product_id,type,status'); $sp6f7226 = $spdd9f33->post('current_page', 1); $spaba533 = $spdd9f33->post('per_page', 20); $spec1114 = $sp26c3c2->paginate($spaba533, array('*'), 'page', $sp6f7226); return Response::success($spec1114); } function create(Request $spdd9f33) { $spbc55c7 = $spdd9f33->post('count', 0); $sp9d3dc0 = (int) $spdd9f33->post('type', \App\Coupon::TYPE_ONETIME); $spfe570a = $spdd9f33->post('expire_at'); $sped46cd = (int) $spdd9f33->post('discount_val'); $sp78883b = (int) $spdd9f33->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); $spc46fc3 = $spdd9f33->post('remark'); if ($sp78883b === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($sped46cd < 1 || $sped46cd > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp78883b === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($sped46cd < 1 || $sped46cd > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $sp4a6190 = (int) $spdd9f33->post('category_id', -1); $spfafc60 = (int) $spdd9f33->post('product_id', -1); if ($sp9d3dc0 === \App\Coupon::TYPE_REPEAT) { $spe017d6 = $spdd9f33->post('coupon'); if (!$spe017d6) { $spe017d6 = strtoupper(str_random()); } $spe42bdc = new \App\Coupon(); $spe42bdc->user_id = $this->getUserIdOrFail($spdd9f33); $spe42bdc->category_id = $sp4a6190; $spe42bdc->product_id = $spfafc60; $spe42bdc->coupon = $spe017d6; $spe42bdc->type = $sp9d3dc0; $spe42bdc->discount_val = $sped46cd; $spe42bdc->discount_type = $sp78883b; $spe42bdc->count_all = (int) $spdd9f33->post('count_all', 1); if ($spe42bdc->count_all < 1 || $spe42bdc->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } $spe42bdc->expire_at = $spfe570a; $spe42bdc->saveOrFail(); return Response::success(array($spe42bdc->coupon)); } elseif ($sp9d3dc0 === \App\Coupon::TYPE_ONETIME) { if (!$spbc55c7) { return Response::forbidden('请输入生成数量'); } if ($spbc55c7 > 100) { return Response::forbidden('每次生成不能大于100张'); } $sp2130e7 = array(); $sp51ff5b = array(); $spc7622d = $this->getUserIdOrFail($spdd9f33); $sp2828f9 = Carbon::now(); for ($spfae064 = 0; $spfae064 < $spbc55c7; $spfae064++) { $spe42bdc = strtoupper(str_random()); $sp51ff5b[] = $spe42bdc; $sp2130e7[] = array('user_id' => $spc7622d, 'coupon' => $spe42bdc, 'category_id' => $sp4a6190, 'product_id' => $spfafc60, 'type' => $sp9d3dc0, 'discount_val' => $sped46cd, 'discount_type' => $sp78883b, 'status' => \App\Coupon::STATUS_NORMAL, 'remark' => $spc46fc3, 'created_at' => $sp2828f9, 'expire_at' => $spfe570a); } \App\Coupon::insert($sp2130e7); return Response::success($sp51ff5b); } else { return Response::forbidden('unknown type: ' . $sp9d3dc0); } } function edit(Request $spdd9f33) { $sp403bd7 = (int) $spdd9f33->post('id'); $spe017d6 = $spdd9f33->post('coupon'); $sp4a6190 = (int) $spdd9f33->post('category_id', -1); $spfafc60 = (int) $spdd9f33->post('product_id', -1); $spfe570a = $spdd9f33->post('expire_at', NULL); $spb55c72 = (int) $spdd9f33->post('status', \App\Coupon::STATUS_NORMAL); $sp9d3dc0 = (int) $spdd9f33->post('type', \App\Coupon::TYPE_ONETIME); $sped46cd = (int) $spdd9f33->post('discount_val'); $sp78883b = (int) $spdd9f33->post('discount_type', \App\Coupon::DISCOUNT_TYPE_AMOUNT); if ($sp78883b === \App\Coupon::DISCOUNT_TYPE_AMOUNT) { if ($sped46cd < 1 || $sped46cd > 1000000000) { return Response::fail('优惠券面额需要在0.01-10000000之间'); } } if ($sp78883b === \App\Coupon::DISCOUNT_TYPE_PERCENT) { if ($sped46cd < 1 || $sped46cd > 100) { return Response::fail('优惠券面额需要在1-100之间'); } } $spe42bdc = $this->authQuery($spdd9f33, \App\Coupon::class)->find($sp403bd7); if ($spe42bdc) { $spe42bdc->coupon = $spe017d6; $spe42bdc->category_id = $sp4a6190; $spe42bdc->product_id = $spfafc60; $spe42bdc->status = $spb55c72; $spe42bdc->type = $sp9d3dc0; $spe42bdc->discount_val = $sped46cd; $spe42bdc->discount_type = $sp78883b; if ($sp9d3dc0 === \App\Coupon::TYPE_REPEAT) { $spe42bdc->count_all = (int) $spdd9f33->post('count_all', 1); if ($spe42bdc->count_all < 1 || $spe42bdc->count_all > 10000000) { return Response::fail('可用次数不能超过10000000'); } } if ($spfe570a) { $spe42bdc->expire_at = $spfe570a; } $spe42bdc->saveOrFail(); } else { $sp251d85 = explode('
', $spe017d6); for ($spfae064 = 0; $spfae064 < count($sp251d85); $spfae064++) { $spf81d05 = str_replace('', '', trim($sp251d85[$spfae064])); $spe42bdc = new \App\Coupon(); $spe42bdc->coupon = $spf81d05; $spe42bdc->category_id = $sp4a6190; $spe42bdc->product_id = $spfafc60; $spe42bdc->status = $spb55c72; $spe42bdc->type = $sp9d3dc0; $spe42bdc->discount_val = $sped46cd; $spe42bdc->discount_type = $sp78883b; $sp251d85[$spfae064] = $spe42bdc; } \App\Product::find($spfafc60)->coupons()->saveMany($sp251d85); } return Response::success(); } function enable(Request $spdd9f33) { $sp12219c = $spdd9f33->post('ids', ''); if (strlen($sp12219c) < 1) { return Response::forbidden(); } $spc08eb6 = (int) $spdd9f33->post('enabled'); $this->authQuery($spdd9f33, \App\Coupon::class)->whereIn('id', explode(',', $sp12219c))->update(array('enabled' => $spc08eb6)); return Response::success(); } function delete(Request $spdd9f33) { $sp12219c = $spdd9f33->post('ids', ''); if (strlen($sp12219c) < 1) { return Response::forbidden(); } $this->authQuery($spdd9f33, \App\Coupon::class)->whereIn('id', explode(',', $sp12219c))->delete(); return Response::success(); } }