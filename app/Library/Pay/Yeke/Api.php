<?php
namespace App\Library\Pay\Yeke; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp403bd7) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp403bd7; $this->url_return = SYS_URL . '/pay/return/' . $sp403bd7; } function goPay($sp4d5cc2, $sp2714cc, $spc644e5, $sp5b5e88, $sp9d9f48) { $sp6246a9 = sprintf('%.2f', $sp9d9f48 / 100); define('yeke_USER_ID', $sp4d5cc2['id']); define('yeke_USER_KEY', $sp4d5cc2['key']); define('yeke_USER_LOG_PREFIX', 'log'); define('yeke_API_GATE', 'http://www.yekepay.com/api/ApiGo.php'); $spb281f4 = strtolower($sp4d5cc2['payway']); $spfd5b04 = ''; $sp8e721a = ''; if ($spb281f4 == 'alipay' || $spb281f4 == 'alipay_wap') { $spfd5b04 = 'alipay'; $sp8e721a = 'ALIPAY'; } elseif ($spb281f4 == 'tenpay' || $spb281f4 == 'tenpay_wap') { $spfd5b04 = 'tenpay'; $sp8e721a = 'TENPAY'; } elseif ($spb281f4 == 'weixin') { $spfd5b04 = 'weixin'; $sp8e721a = 'WEIXIN'; } elseif ($spb281f4 == 'weixin_wap') { $spfd5b04 = 'wxwap'; $sp8e721a = 'wxwap'; } elseif ($spb281f4 == 'qq' || $spb281f4 == 'qq_wap') { $spfd5b04 = 'sqzf'; $sp8e721a = 'sqzf'; } elseif ($spb281f4 == 'qq_wap') { $spfd5b04 = 'sqzfqb'; $sp8e721a = 'sqzfqb'; } require 'yekeApiLib.php'; require 'HttpClient.php'; $spc644e5 = mb_substr($spc644e5, 0, 50, 'UTF-8'); $sp5b5e88 = mb_substr($sp5b5e88, 0, 100, 'UTF-8'); $sp50fc45 = array('P_orderid' => $sp2714cc, 'P_paymoney' => $sp6246a9, 'P_productname' => urlencode($spc644e5), 'P_productinfo' => urlencode($sp5b5e88), 'P_remark' => urlencode($sp2714cc), 'P_custom_1' => urlencode($sp8e721a), 'P_custom_2' => '', 'P_contact' => urlencode(SYS_NAME), 'P_paytype' => $spfd5b04, 'P_gateway' => $sp8e721a, 'P_cardnum' => '', 'P_cardpwd' => '', 'P_cardvalue' => '', 'P_notify_url' => $this->url_notify, 'P_return_url' => $this->url_return . '/' . $sp2714cc); $spf65830 = new \yekeAPI(); $spc4a98e = $spf65830->payGate($sp50fc45); echo $spc4a98e; } function verify($sp4d5cc2, $spae1cf8) { $sp5c532f = isset($sp4d5cc2['isNotify']) && $sp4d5cc2['isNotify']; define('yeke_USER_ID', $sp4d5cc2['id']); define('yeke_USER_KEY', $sp4d5cc2['key']); define('yeke_USER_LOG_PREFIX', 'log'); define('yeke_API_GATE', 'http://www.yekepay.com/api/ApiGo.php'); require 'HttpClient.php'; require 'yekeApiLib.php'; $spf65830 = new \yekeAPI(); if ($sp5c532f) { $spc4a98e = $spf65830->verifyNotify(); } else { $spc4a98e = $spf65830->verifyReturn(); } if ($spc4a98e) { $spb71e26 = $_REQUEST['P_orderid']; $spd31d1e = $_REQUEST['P_api_orderid']; $sp8610fb = $_REQUEST['P_money']; if ($_REQUEST['P_status'] == 'SUCCESS') { $spae1cf8($spd31d1e, (int) ($sp8610fb * 100), $spb71e26); if ($sp5c532f) { echo 'success'; } return true; } else { if ($sp5c532f) { echo '失败订单'; } } } else { if ($sp5c532f) { echo '验证失败'; } } return false; } }