<?php
namespace Xhat\Payjs; class Payjs { private $mchid; private $key; private $api_url_native; private $api_url_cashier; private $api_url_refund; private $api_url_close; private $api_url_check; private $api_url_user; private $api_url_info; private $api_url_bank; public function __construct($spa9e109 = null) { if (!$spa9e109) { die('config needed'); } $this->mchid = $spa9e109['mchid']; $this->key = $spa9e109['key']; $sp2a84f8 = isset($spa9e109['api_url']) ? $spa9e109['api_url'] : 'https://payjs.cn/api/'; $this->api_url_native = $sp2a84f8 . 'native'; $this->api_url_cashier = $sp2a84f8 . 'cashier'; $this->api_url_refund = $sp2a84f8 . 'refund'; $this->api_url_close = $sp2a84f8 . 'close'; $this->api_url_check = $sp2a84f8 . 'check'; $this->api_url_user = $sp2a84f8 . 'user'; $this->api_url_info = $sp2a84f8 . 'info'; $this->api_url_bank = $sp2a84f8 . 'bank'; } public function native(array $sp29e0c7) { $this->url = $this->api_url_native; return $this->post($sp29e0c7); } public function cashier(array $sp29e0c7) { $this->url = $this->api_url_cashier; $sp29e0c7 = $this->sign($sp29e0c7); $sp11a0e0 = $this->url . '?' . http_build_query($sp29e0c7); return $sp11a0e0; } public function refund($sp6a465f) { $this->url = $this->api_url_refund; $sp29e0c7 = array('payjs_order_id' => $sp6a465f); return $this->post($sp29e0c7); } public function close($sp6a465f) { $this->url = $this->api_url_close; $sp29e0c7 = array('payjs_order_id' => $sp6a465f); return $this->post($sp29e0c7); } public function check($sp6a465f) { $this->url = $this->api_url_check; $sp29e0c7 = array('payjs_order_id' => $sp6a465f); return $this->post($sp29e0c7); } public function user($sp4d6482) { $this->url = $this->api_url_user; $sp29e0c7 = array('openid' => $sp4d6482); return $this->post($sp29e0c7); } public function info() { $this->url = $this->api_url_info; $sp29e0c7 = array(); return $this->post($sp29e0c7); } public function bank($spb0d9eb) { $this->url = $this->api_url_bank; $sp29e0c7 = array('bank' => $spb0d9eb); return $this->post($sp29e0c7); } public function notify() { $sp29e0c7 = $_POST; if ($this->checkSign($sp29e0c7) === true) { return $sp29e0c7; } else { return '验签失败'; } } public function sign(array $sp29e0c7) { $sp29e0c7['mchid'] = $this->mchid; array_filter($sp29e0c7); ksort($sp29e0c7); $sp29e0c7['sign'] = strtoupper(md5(urldecode(http_build_query($sp29e0c7) . '&key=' . $this->key))); return $sp29e0c7; } public function checkSign($sp29e0c7) { $spa46376 = $sp29e0c7['sign']; unset($sp29e0c7['sign']); array_filter($sp29e0c7); ksort($sp29e0c7); $sp9c9a88 = strtoupper(md5(urldecode(http_build_query($sp29e0c7) . '&key=' . $this->key))); return $spa46376 == $sp9c9a88 ? true : false; } private static function curl_post($sp11a0e0, $spf7cec4 = '') { $sp77ba0d['Accept'] = '*/*'; $sp77ba0d['Referer'] = $sp11a0e0; $sp77ba0d['Content-Type'] = 'application/x-www-form-urlencoded'; $sp77ba0d['User-Agent'] = 'ni shi sha bi ba, yi ge sdk hai you di san fang ku'; $sp2a6e46 = array(); foreach ($sp77ba0d as $sp9f0fbb => $sp9f6c87) { $sp2a6e46[] = $sp9f0fbb . ': ' . $sp9f6c87; } $sp2a6e46[] = 'Expect:'; $sp082589 = curl_init(); curl_setopt($sp082589, CURLOPT_URL, $sp11a0e0); curl_setopt($sp082589, CURLOPT_POST, 1); curl_setopt($sp082589, CURLOPT_POSTFIELDS, $spf7cec4); curl_setopt($sp082589, CURLOPT_TIMEOUT, 10); curl_setopt($sp082589, CURLOPT_CONNECTTIMEOUT, 10); curl_setopt($sp082589, CURLOPT_RETURNTRANSFER, 1); curl_setopt($sp082589, CURLOPT_HEADER, 1); curl_setopt($sp082589, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($sp082589, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($sp082589, CURLOPT_HTTPHEADER, $sp2a6e46); $sp0e2174 = curl_exec($sp082589); $sp71924e = curl_getinfo($sp082589, CURLINFO_HEADER_SIZE); $sp92f0c1 = substr($sp0e2174, $sp71924e); curl_close($sp082589); return $sp92f0c1; } public function post($sp29e0c7) { $sp29e0c7 = $this->sign($sp29e0c7); return json_decode(self::curl_post($this->url, http_build_query($sp29e0c7)), true); } }