<?php
require_once 'alipay_core.function.php'; require_once 'alipay_md5.function.php'; class AlipayNotify { var $https_verify_url = 'https://mapi.alipay.com/gateway.do?service=notify_verify&'; var $http_verify_url = 'http://notify.alipay.com/trade/notify_query.do?'; var $alipay_config; function __construct($sp394da4) { $this->alipay_config = $sp394da4; } function AlipayNotify($sp394da4) { $this->__construct($sp394da4); } function verifyNotify() { if (empty($_POST)) { return false; } else { $sp6f7a0b = $this->getSignVeryfy($_POST, $_POST['sign']); $spb8a16b = 'false'; if (!empty($_POST['notify_id'])) { $spb8a16b = $this->getResponse($_POST['notify_id']); } if (preg_match('/true$/i', $spb8a16b) && $sp6f7a0b) { return true; } else { return false; } } } function verifyReturn() { if (empty($_GET)) { return false; } else { $sp6f7a0b = $this->getSignVeryfy($_GET, $_GET['sign']); $spb8a16b = 'false'; if (!empty($_GET['notify_id'])) { $spb8a16b = $this->getResponse($_GET['notify_id']); } if (preg_match('/true$/i', $spb8a16b) && $sp6f7a0b) { return true; } else { return false; } } } function getSignVeryfy($spd42b29, $sp36c1ea) { $sp060a75 = paraFilter($spd42b29); $sp12a9cd = argSort($sp060a75); $spa00b0c = createLinkString($sp12a9cd); $sp232276 = false; switch (strtoupper(trim($this->alipay_config['sign_type']))) { case 'MD5': $sp232276 = md5Verify($spa00b0c, $sp36c1ea, $this->alipay_config['key']); break; default: $sp232276 = false; } return $sp232276; } function getResponse($sp846ef6) { $sp4e60dc = strtolower(trim($this->alipay_config['transport'])); $sp5a1c1d = trim($this->alipay_config['partner']); $spab81e0 = ''; if ($sp4e60dc == 'https') { $spab81e0 = $this->https_verify_url; } else { $spab81e0 = $this->http_verify_url; } $spab81e0 = $spab81e0 . 'partner=' . $sp5a1c1d . '&notify_id=' . $sp846ef6; $spb8a16b = getHttpResponseGET($spab81e0, $this->alipay_config['cacert']); return $spb8a16b; } }