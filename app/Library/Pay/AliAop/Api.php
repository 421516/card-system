<?php
namespace App\Library\Pay\AliAop; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; private $aop = null; public function __construct($spf46c5d) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spf46c5d; $this->url_return = SYS_URL . '/pay/return/' . $spf46c5d; } private function aop($spa9e109) { if ($this->aop === null) { $sp4954b9 = \Alipay\Key\AlipayKeyPair::create('-----BEGIN RSA PRIVATE KEY-----
' . wordwrap($spa9e109['merchant_private_key'], 64, '
', true) . '
-----END RSA PRIVATE KEY-----', '-----BEGIN PUBLIC KEY-----
' . wordwrap($spa9e109['alipay_public_key'], 64, '
', true) . '
-----END PUBLIC KEY-----'); $this->aop = new \Alipay\AopClient($spa9e109['app_id'], $sp4954b9); } return $this->aop; } function goPay($spa9e109, $sp206d07, $sp89af34, $sp92f0c1, $sp28f24f) { $sp9a8a75 = sprintf('%.2f', $sp28f24f / 100); if ($spa9e109['payway'] === 'f2f') { $sp85ba11 = \Alipay\AlipayRequestFactory::create('alipay.trade.precreate', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp206d07, 'total_amount' => $sp9a8a75, 'subject' => $sp89af34))); $sp9610ab = $this->aop($spa9e109)->execute($sp85ba11)->getData(); header('location: /qrcode/pay/' . $sp206d07 . '/aliqr?url=' . urlencode($sp9610ab['qr_code'])); } elseif ($spa9e109['payway'] === 'pc') { $sp85ba11 = \Alipay\AlipayRequestFactory::create('alipay.trade.page.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp206d07, 'product_code' => 'FAST_INSTANT_TRADE_PAY', 'total_amount' => $sp9a8a75, 'subject' => $sp89af34))); $sp9610ab = $this->aop($spa9e109)->pageExecuteUrl($sp85ba11); header('location: ' . $sp9610ab); } elseif ($spa9e109['payway'] === 'mobile') { $sp85ba11 = \Alipay\AlipayRequestFactory::create('alipay.trade.wap.pay', array('return_url' => $this->url_return, 'notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp206d07, 'product_code' => 'QUICK_WAP_WAY', 'total_amount' => $sp9a8a75, 'subject' => $sp89af34))); $sp9610ab = $this->aop($spa9e109)->pageExecuteUrl($sp85ba11); header('location: ' . $sp9610ab); } die; } function verify($spa9e109, $spf8927a) { $spf53f48 = isset($spa9e109['isNotify']) && $spa9e109['isNotify']; if ($spf53f48) { if ($this->aop($spa9e109)->verify($_POST)) { if ($_POST['trade_status'] === 'TRADE_SUCCESS') { $spe62189 = $_POST['trade_no']; $spbc3979 = (int) round($_POST['total_amount'] * 100); $spf8927a($_POST['out_trade_no'], $spbc3979, $spe62189); } } else { Log::error('Pay.AliAop.goPay.verify Error: ' . json_encode($_POST)); } echo 'success'; die; } if (!empty($spa9e109['out_trade_no'])) { $sp206d07 = $spa9e109['out_trade_no']; $sp85ba11 = \Alipay\AlipayRequestFactory::create('alipay.trade.query', array('notify_url' => $this->url_notify, 'biz_content' => array('out_trade_no' => $sp206d07))); try { $sp9610ab = $this->aop($spa9e109)->execute($sp85ba11)->getData(); } catch (\Throwable $sp1b3a33) { return false; } if ($sp9610ab['trade_status'] === 'TRADE_SUCCESS') { $spe62189 = $sp9610ab['trade_no']; $spbc3979 = (int) round($sp9610ab['total_amount'] * 100); $spf8927a($sp9610ab['out_trade_no'], $spbc3979, $spe62189); return true; } } else { $sp6ff23c = $this->aop($spa9e109)->verify($_GET); if (!$sp6ff23c) { throw new \Exception('支付宝签名校验失败'); } $spe62189 = $_GET['trade_no']; $spbc3979 = (int) round($_GET['total_amount'] * 100); $spf8927a($_GET['out_trade_no'], $spbc3979, $spe62189); return true; } return false; } }