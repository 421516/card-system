<?php
require_once '../lib/WxPay.Api.php'; class MicroPay { public function pay($spcd416c) { $sp9610ab = WxPayApi::micropay($spcd416c, 5); if (!array_key_exists('return_code', $sp9610ab) || !array_key_exists('out_trade_no', $sp9610ab) || !array_key_exists('result_code', $sp9610ab)) { echo '接口调用失败,请确认是否输入是否有误！'; throw new WxPayException('接口调用失败！'); } $sp206d07 = $spcd416c->GetOut_trade_no(); if ($sp9610ab['return_code'] == 'SUCCESS' && $sp9610ab['result_code'] == 'FAIL' && $sp9610ab['err_code'] != 'USERPAYING' && $sp9610ab['err_code'] != 'SYSTEMERROR') { return false; } $sp26837c = 10; while ($sp26837c > 0) { $sp7d4043 = 0; $sp10b0eb = $this->query($sp206d07, $sp7d4043); if ($sp7d4043 == 2) { sleep(2); continue; } else { if ($sp7d4043 == 1) { return $sp10b0eb; } else { return false; } } } if (!$this->cancel($sp206d07)) { throw new WxpayException('撤销单失败！'); } return false; } public function query($sp206d07, &$spa4aff0) { $sp8b6feb = new WxPayOrderQuery(); $sp8b6feb->SetOut_trade_no($sp206d07); $sp9610ab = WxPayApi::orderQuery($sp8b6feb); if ($sp9610ab['return_code'] == 'SUCCESS' && $sp9610ab['result_code'] == 'SUCCESS') { if ($sp9610ab['trade_state'] == 'SUCCESS') { $spa4aff0 = 1; return $sp9610ab; } else { if ($sp9610ab['trade_state'] == 'USERPAYING') { $spa4aff0 = 2; return false; } } } if ($sp9610ab['err_code'] == 'ORDERNOTEXIST') { $spa4aff0 = 0; } else { $spa4aff0 = 2; } return false; } public function cancel($sp206d07, $sp9a518d = 0) { if ($sp9a518d > 10) { return false; } $spa9d741 = new WxPayReverse(); $spa9d741->SetOut_trade_no($sp206d07); $sp9610ab = WxPayApi::reverse($spa9d741); if ($sp9610ab['return_code'] != 'SUCCESS') { return false; } if ($sp9610ab['result_code'] != 'SUCCESS' && $sp9610ab['recall'] == 'N') { return true; } else { if ($sp9610ab['recall'] == 'Y') { return $this->cancel($sp206d07, ++$sp9a518d); } } return false; } }