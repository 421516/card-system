<?php
require_once '../lib/WxPay.Api.php'; class MicroPay { public function pay($sp311659) { $spbcb528 = WxPayApi::micropay($sp311659, 5); if (!array_key_exists('return_code', $spbcb528) || !array_key_exists('out_trade_no', $spbcb528) || !array_key_exists('result_code', $spbcb528)) { echo '接口调用失败,请确认是否输入是否有误！'; throw new WxPayException('接口调用失败！'); } $spbd054b = $sp311659->GetOut_trade_no(); if ($spbcb528['return_code'] == 'SUCCESS' && $spbcb528['result_code'] == 'FAIL' && $spbcb528['err_code'] != 'USERPAYING' && $spbcb528['err_code'] != 'SYSTEMERROR') { return false; } $sp010e09 = 10; while ($sp010e09 > 0) { $sp5dac0b = 0; $sp64b49c = $this->query($spbd054b, $sp5dac0b); if ($sp5dac0b == 2) { sleep(2); continue; } else { if ($sp5dac0b == 1) { return $sp64b49c; } else { return false; } } } if (!$this->cancel($spbd054b)) { throw new WxpayException('撤销单失败！'); } return false; } public function query($spbd054b, &$sp05ad76) { $sp724da4 = new WxPayOrderQuery(); $sp724da4->SetOut_trade_no($spbd054b); $spbcb528 = WxPayApi::orderQuery($sp724da4); if ($spbcb528['return_code'] == 'SUCCESS' && $spbcb528['result_code'] == 'SUCCESS') { if ($spbcb528['trade_state'] == 'SUCCESS') { $sp05ad76 = 1; return $spbcb528; } else { if ($spbcb528['trade_state'] == 'USERPAYING') { $sp05ad76 = 2; return false; } } } if ($spbcb528['err_code'] == 'ORDERNOTEXIST') { $sp05ad76 = 0; } else { $sp05ad76 = 2; } return false; } public function cancel($spbd054b, $sp269737 = 0) { if ($sp269737 > 10) { return false; } $sp89e272 = new WxPayReverse(); $sp89e272->SetOut_trade_no($spbd054b); $spbcb528 = WxPayApi::reverse($sp89e272); if ($spbcb528['return_code'] != 'SUCCESS') { return false; } if ($spbcb528['result_code'] != 'SUCCESS' && $spbcb528['recall'] == 'N') { return true; } else { if ($spbcb528['recall'] == 'Y') { return $this->cancel($spbd054b, ++$sp269737); } } return false; } }