<?php
require_once '../lib/WxPay.Api.php'; class MicroPay { public function pay($sp1e462c) { $sp836ce6 = WxPayApi::micropay($sp1e462c, 5); if (!array_key_exists('return_code', $sp836ce6) || !array_key_exists('out_trade_no', $sp836ce6) || !array_key_exists('result_code', $sp836ce6)) { echo '接口调用失败,请确认是否输入是否有误！'; throw new WxPayException('接口调用失败！'); } $sp6281ad = $sp1e462c->GetOut_trade_no(); if ($sp836ce6['return_code'] == 'SUCCESS' && $sp836ce6['result_code'] == 'FAIL' && $sp836ce6['err_code'] != 'USERPAYING' && $sp836ce6['err_code'] != 'SYSTEMERROR') { return false; } $sp5b4cba = 10; while ($sp5b4cba > 0) { $spaf0090 = 0; $sp2d5af3 = $this->query($sp6281ad, $spaf0090); if ($spaf0090 == 2) { sleep(2); continue; } else { if ($spaf0090 == 1) { return $sp2d5af3; } else { return false; } } } if (!$this->cancel($sp6281ad)) { throw new WxpayException('撤销单失败！'); } return false; } public function query($sp6281ad, &$sp98c407) { $sp9cd022 = new WxPayOrderQuery(); $sp9cd022->SetOut_trade_no($sp6281ad); $sp836ce6 = WxPayApi::orderQuery($sp9cd022); if ($sp836ce6['return_code'] == 'SUCCESS' && $sp836ce6['result_code'] == 'SUCCESS') { if ($sp836ce6['trade_state'] == 'SUCCESS') { $sp98c407 = 1; return $sp836ce6; } else { if ($sp836ce6['trade_state'] == 'USERPAYING') { $sp98c407 = 2; return false; } } } if ($sp836ce6['err_code'] == 'ORDERNOTEXIST') { $sp98c407 = 0; } else { $sp98c407 = 2; } return false; } public function cancel($sp6281ad, $spe99ad0 = 0) { if ($spe99ad0 > 10) { return false; } $spebfa80 = new WxPayReverse(); $spebfa80->SetOut_trade_no($sp6281ad); $sp836ce6 = WxPayApi::reverse($spebfa80); if ($sp836ce6['return_code'] != 'SUCCESS') { return false; } if ($sp836ce6['result_code'] != 'SUCCESS' && $sp836ce6['recall'] == 'N') { return true; } else { if ($sp836ce6['recall'] == 'Y') { return $this->cancel($sp6281ad, ++$spe99ad0); } } return false; } }