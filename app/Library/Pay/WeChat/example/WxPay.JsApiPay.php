<?php
require_once '../lib/WxPay.Api.php'; class JsApiPay { public $data = null; public function GetOpenid() { if (!isset($_GET['code'])) { $spec4a66 = urlencode('http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] . $_SERVER['QUERY_STRING']); $sp11a0e0 = $this->__CreateOauthUrlForCode($spec4a66); Header("Location: {$sp11a0e0}"); die; } else { $spe54fd8 = $_GET['code']; $sp4d6482 = $this->getOpenidFromMp($spe54fd8); return $sp4d6482; } } public function GetJsApiParameters($spc6fa78) { if (!array_key_exists('appid', $spc6fa78) || !array_key_exists('prepay_id', $spc6fa78) || $spc6fa78['prepay_id'] == '') { throw new WxPayException('参数错误'); } $sp2c0ae6 = new WxPayJsApiPay(); $sp2c0ae6->SetAppid($spc6fa78['appid']); $spf2719a = time(); $sp2c0ae6->SetTimeStamp("{$spf2719a}"); $sp2c0ae6->SetNonceStr(WxPayApi::getNonceStr()); $sp2c0ae6->SetPackage('prepay_id=' . $spc6fa78['prepay_id']); $sp2c0ae6->SetSignType('MD5'); $sp2c0ae6->SetPaySign($sp2c0ae6->MakeSign()); $spee8b27 = json_encode($sp2c0ae6->GetValues()); return $spee8b27; } public function GetOpenidFromMp($spe54fd8) { $sp11a0e0 = $this->__CreateOauthUrlForOpenid($spe54fd8); $sp082589 = curl_init(); curl_setopt($sp082589, CURLOPT_TIMEOUT, $this->curl_timeout); curl_setopt($sp082589, CURLOPT_URL, $sp11a0e0); curl_setopt($sp082589, CURLOPT_SSL_VERIFYPEER, FALSE); curl_setopt($sp082589, CURLOPT_SSL_VERIFYHOST, FALSE); curl_setopt($sp082589, CURLOPT_HEADER, FALSE); curl_setopt($sp082589, CURLOPT_RETURNTRANSFER, TRUE); if (WxPayConfig::CURL_PROXY_HOST != '0.0.0.0' && WxPayConfig::CURL_PROXY_PORT != 0) { curl_setopt($sp082589, CURLOPT_PROXY, WxPayConfig::CURL_PROXY_HOST); curl_setopt($sp082589, CURLOPT_PROXYPORT, WxPayConfig::CURL_PROXY_PORT); } $sp3dc071 = curl_exec($sp082589); curl_close($sp082589); $sp29e0c7 = json_decode($sp3dc071, true); $this->data = $sp29e0c7; $sp4d6482 = $sp29e0c7['openid']; return $sp4d6482; } private function ToUrlParams($sp1e1fcd) { $sp8942fa = ''; foreach ($sp1e1fcd as $sp614732 => $sp154f6e) { if ($sp614732 != 'sign') { $sp8942fa .= $sp614732 . '=' . $sp154f6e . '&'; } } $sp8942fa = trim($sp8942fa, '&'); return $sp8942fa; } public function GetEditAddressParameters() { $sp4753a4 = $this->data; $sp29e0c7 = array(); $sp29e0c7['appid'] = WxPayConfig::APPID; $sp29e0c7['url'] = 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $spd97c80 = time(); $sp29e0c7['timestamp'] = "{$spd97c80}"; $sp29e0c7['noncestr'] = '1234568'; $sp29e0c7['accesstoken'] = $sp4753a4['access_token']; ksort($sp29e0c7); $sp20678b = $this->ToUrlParams($sp29e0c7); $sp19b7b6 = sha1($sp20678b); $sp299248 = array('addrSign' => $sp19b7b6, 'signType' => 'sha1', 'scope' => 'jsapi_address', 'appId' => WxPayConfig::APPID, 'timeStamp' => $sp29e0c7['timestamp'], 'nonceStr' => $sp29e0c7['noncestr']); $spee8b27 = json_encode($sp299248); return $spee8b27; } private function __CreateOauthUrlForCode($sp69033e) { $sp1e1fcd['appid'] = WxPayConfig::APPID; $sp1e1fcd['redirect_uri'] = "{$sp69033e}"; $sp1e1fcd['response_type'] = 'code'; $sp1e1fcd['scope'] = 'snsapi_base'; $sp1e1fcd['state'] = 'STATE' . '#wechat_redirect'; $sp3544f2 = $this->ToUrlParams($sp1e1fcd); return 'https://open.weixin.qq.com/connect/oauth2/authorize?' . $sp3544f2; } private function __CreateOauthUrlForOpenid($spe54fd8) { $sp1e1fcd['appid'] = WxPayConfig::APPID; $sp1e1fcd['secret'] = WxPayConfig::APPSECRET; $sp1e1fcd['code'] = $spe54fd8; $sp1e1fcd['grant_type'] = 'authorization_code'; $sp3544f2 = $this->ToUrlParams($sp1e1fcd); return 'https://api.weixin.qq.com/sns/oauth2/access_token?' . $sp3544f2; } }