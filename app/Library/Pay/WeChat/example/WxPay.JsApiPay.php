<?php
require_once '../lib/WxPay.Api.php'; class JsApiPay { public $data = null; public function GetOpenid() { if (!isset($_GET['code'])) { $spe6ee4d = urlencode('http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] . $_SERVER['QUERY_STRING']); $spdfc1ea = $this->__CreateOauthUrlForCode($spe6ee4d); Header("Location: {$spdfc1ea}"); die; } else { $spd0703e = $_GET['code']; $spd2f669 = $this->getOpenidFromMp($spd0703e); return $spd2f669; } } public function GetJsApiParameters($sp2ffa69) { if (!array_key_exists('appid', $sp2ffa69) || !array_key_exists('prepay_id', $sp2ffa69) || $sp2ffa69['prepay_id'] == '') { throw new WxPayException('参数错误'); } $spec03b9 = new WxPayJsApiPay(); $spec03b9->SetAppid($sp2ffa69['appid']); $sp1738fa = time(); $spec03b9->SetTimeStamp("{$sp1738fa}"); $spec03b9->SetNonceStr(WxPayApi::getNonceStr()); $spec03b9->SetPackage('prepay_id=' . $sp2ffa69['prepay_id']); $spec03b9->SetSignType('MD5'); $spec03b9->SetPaySign($spec03b9->MakeSign()); $sp46a5c7 = json_encode($spec03b9->GetValues()); return $sp46a5c7; } public function GetOpenidFromMp($spd0703e) { $spdfc1ea = $this->__CreateOauthUrlForOpenid($spd0703e); $spde874d = curl_init(); curl_setopt($spde874d, CURLOPT_TIMEOUT, $this->curl_timeout); curl_setopt($spde874d, CURLOPT_URL, $spdfc1ea); curl_setopt($spde874d, CURLOPT_SSL_VERIFYPEER, FALSE); curl_setopt($spde874d, CURLOPT_SSL_VERIFYHOST, FALSE); curl_setopt($spde874d, CURLOPT_HEADER, FALSE); curl_setopt($spde874d, CURLOPT_RETURNTRANSFER, TRUE); if (WxPayConfig::CURL_PROXY_HOST != '0.0.0.0' && WxPayConfig::CURL_PROXY_PORT != 0) { curl_setopt($spde874d, CURLOPT_PROXY, WxPayConfig::CURL_PROXY_HOST); curl_setopt($spde874d, CURLOPT_PROXYPORT, WxPayConfig::CURL_PROXY_PORT); } $sp36d3e9 = curl_exec($spde874d); curl_close($spde874d); $sp1835de = json_decode($sp36d3e9, true); $this->data = $sp1835de; $spd2f669 = $sp1835de['openid']; return $spd2f669; } private function ToUrlParams($sp9c98b7) { $sp7339d2 = ''; foreach ($sp9c98b7 as $spa8af52 => $sp651922) { if ($spa8af52 != 'sign') { $sp7339d2 .= $spa8af52 . '=' . $sp651922 . '&'; } } $sp7339d2 = trim($sp7339d2, '&'); return $sp7339d2; } public function GetEditAddressParameters() { $sp8f81bb = $this->data; $sp1835de = array(); $sp1835de['appid'] = WxPayConfig::APPID; $sp1835de['url'] = 'http://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI']; $spd2330d = time(); $sp1835de['timestamp'] = "{$spd2330d}"; $sp1835de['noncestr'] = '1234568'; $sp1835de['accesstoken'] = $sp8f81bb['access_token']; ksort($sp1835de); $spb9d69c = $this->ToUrlParams($sp1835de); $sp1f78a7 = sha1($spb9d69c); $sp9981ab = array('addrSign' => $sp1f78a7, 'signType' => 'sha1', 'scope' => 'jsapi_address', 'appId' => WxPayConfig::APPID, 'timeStamp' => $sp1835de['timestamp'], 'nonceStr' => $sp1835de['noncestr']); $sp46a5c7 = json_encode($sp9981ab); return $sp46a5c7; } private function __CreateOauthUrlForCode($sp1d84a6) { $sp9c98b7['appid'] = WxPayConfig::APPID; $sp9c98b7['redirect_uri'] = "{$sp1d84a6}"; $sp9c98b7['response_type'] = 'code'; $sp9c98b7['scope'] = 'snsapi_base'; $sp9c98b7['state'] = 'STATE' . '#wechat_redirect'; $sp355276 = $this->ToUrlParams($sp9c98b7); return 'https://open.weixin.qq.com/connect/oauth2/authorize?' . $sp355276; } private function __CreateOauthUrlForOpenid($spd0703e) { $sp9c98b7['appid'] = WxPayConfig::APPID; $sp9c98b7['secret'] = WxPayConfig::APPSECRET; $sp9c98b7['code'] = $spd0703e; $sp9c98b7['grant_type'] = 'authorization_code'; $sp355276 = $this->ToUrlParams($sp9c98b7); return 'https://api.weixin.qq.com/sns/oauth2/access_token?' . $sp355276; } }