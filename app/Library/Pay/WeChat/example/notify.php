<?php
ini_set('date.timezone', 'Asia/Shanghai'); error_reporting(E_ERROR); require_once '../lib/WxPay.Api.php'; require_once '../lib/WxPay.Notify.php'; require_once 'log.php'; $spa904b1 = new CLogFileHandler('../logs/' . date('Y-m-d') . '.log'); $sp01b52a = Log::Init($spa904b1, 15); class PayNotifyCallBack extends WxPayNotify { public function Queryorder($sp6d9277) { $sp106469 = new WxPayOrderQuery(); $sp106469->SetTransaction_id($sp6d9277); $sp836ce6 = WxPayApi::orderQuery($sp106469); Log::DEBUG('query:' . json_encode($sp836ce6)); if (array_key_exists('return_code', $sp836ce6) && array_key_exists('result_code', $sp836ce6) && $sp836ce6['return_code'] == 'SUCCESS' && $sp836ce6['result_code'] == 'SUCCESS') { return true; } return false; } public function NotifyProcess($sp94131d, &$spcb569a) { Log::DEBUG('call back:' . json_encode($sp94131d)); $spaa1e3f = array(); if (!array_key_exists('transaction_id', $sp94131d)) { $spcb569a = '输入参数不正确'; return false; } if (!$this->Queryorder($sp94131d['transaction_id'])) { $spcb569a = '订单查询失败'; return false; } return true; } } Log::DEBUG('begin notify'); $spf1ec9c = new PayNotifyCallBack(); $spf1ec9c->Handle(false);