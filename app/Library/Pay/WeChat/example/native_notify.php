<?php
ini_set('date.timezone', 'Asia/Shanghai'); error_reporting(E_ERROR); require_once '../lib/WxPay.Api.php'; require_once '../lib/WxPay.Notify.php'; require_once '../WxLog.php'; class NativeNotifyCallBack extends WxPayNotify { public function unifiedorder($sp4c42b0, $sp16cfd7) { $spd2b050 = new WxPayUnifiedOrder(); $spd2b050->SetBody('test'); $spd2b050->SetAttach('test'); $spd2b050->SetOut_trade_no(WxPayConfig::MCHID . date('YmdHis')); $spd2b050->SetTotal_fee('1'); $spd2b050->SetTime_start(date('YmdHis')); $spd2b050->SetTime_expire(date('YmdHis', time() + 600)); $spd2b050->SetGoods_tag('test'); $spd2b050->SetNotify_url('http://paysdk.weixin.qq.com/example/notify.php'); $spd2b050->SetTrade_type('NATIVE'); $spd2b050->SetOpenid($sp4c42b0); $spd2b050->SetProduct_id($sp16cfd7); $sp9610ab = WxPayApi::unifiedOrder($spd2b050); \WxLog::DEBUG('unifiedorder:' . json_encode($sp9610ab)); return $sp9610ab; } public function NotifyProcess($sp29e0c7, &$spdfd2b6) { \WxLog::DEBUG('call back:' . json_encode($sp29e0c7)); if (!array_key_exists('openid', $sp29e0c7) || !array_key_exists('product_id', $sp29e0c7)) { $spdfd2b6 = '回调数据异常'; return false; } $sp4d6482 = $sp29e0c7['openid']; $sp16cfd7 = $sp29e0c7['product_id']; $sp9610ab = $this->unifiedorder($sp4d6482, $sp16cfd7); if (!array_key_exists('appid', $sp9610ab) || !array_key_exists('mch_id', $sp9610ab) || !array_key_exists('prepay_id', $sp9610ab)) { $spdfd2b6 = '统一下单失败'; return false; } $this->SetData('appid', $sp9610ab['appid']); $this->SetData('mch_id', $sp9610ab['mch_id']); $this->SetData('nonce_str', WxPayApi::getNonceStr()); $this->SetData('prepay_id', $sp9610ab['prepay_id']); $this->SetData('result_code', 'SUCCESS'); $this->SetData('err_code_des', 'OK'); return true; } } \WxLog::DEBUG('begin notify!'); $sp390b71 = new NativeNotifyCallBack(); $sp390b71->Handle(true);