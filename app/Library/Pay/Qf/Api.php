<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe6149b) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe6149b; $this->url_return = SYS_URL . '/pay/return/' . $spe6149b; } function goPay($spd82bcd, $sp6281ad, $spe4243d, $sp1d246b, $sp54eead) { $spabb601 = strtolower($spd82bcd['payway']); if (!isset($spd82bcd['id'])) { throw new \Exception('请设置 id'); } $sp955824 = array(); if ($spabb601 == 'qq') { $sp955824 = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($spabb601 == 'alipay') { $sp955824 = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $spe5db61 = ''; $sp368597 = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $spd82bcd['id'] . '&opuid=&reqid=' . $sp6281ad, $spe5db61, $sp955824); $sp4b06b6 = static::strBetween($sp368597, 'reqid":"', '"'); $spdb7115 = static::strBetween($sp368597, 'currency":"', '"'); if ($sp4b06b6 == '' || $spdb7115 == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $sp368597); throw new \Exception('获取支付请求id失败'); } $sp4863b0 = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $sp54eead . '&openid=&appid=&huid=' . $spd82bcd['id'] . '&opuid=&reqid=' . $sp4b06b6 . '&balance=0&currency=' . $spdb7115, $spe5db61, $sp955824); $sp836ce6 = json_decode($sp4863b0, true); $sp3327fa = static::strBetween($sp4863b0, 'syssn":"', '"'); if (!$sp836ce6 || $sp3327fa == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $sp4863b0); throw new \Exception('生成支付单号失败#1'); } if ($sp836ce6['respcd'] !== '0000') { if (isset($sp836ce6['respmsg']) && $sp836ce6['respmsg'] !== '') { throw new \Exception($sp836ce6['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $sp4863b0); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($sp6281ad)->update(array('pay_trade_no' => $sp3327fa)); header('location: /qrcode/pay/' . $sp6281ad . '/qf_' . $spabb601 . '?url=' . urlencode(json_encode($sp836ce6['data']['pay_params']))); } function verify($spd82bcd, $spbb5f38) { $sp33b59d = \App\Order::whereOrderNo($spd82bcd['out_trade_no'])->firstOrFail(); $sp3327fa = $sp33b59d->pay_trade_no; $spae8677 = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $sp3327fa); $sped600d = json_decode($spae8677, true); if (!$spae8677) { throw new \Exception('query error'); } if (!isset($sped600d['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $spae8677); throw new \Exception('获取支付结果失败'); } if ($sped600d['respcd'] !== '0000') { return false; } $spded61f = (int) static::strBetween($spae8677, 'trade_amt":', ','); if ($spded61f === 0) { $spded61f = (int) static::strBetween($spae8677, 'txamt":', ','); if ($spded61f === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $spae8677); throw new \Exception('获取支付金额失败'); } } if ($sped600d['respcd'] === '0000') { $spbb5f38($spd82bcd['out_trade_no'], $spded61f, $sp3327fa); return true; } return false; } public static function strBetween($spf6683b, $sp51eb65, $sp5e6650) { $sp62a6f7 = stripos($spf6683b, $sp51eb65); if ($sp62a6f7 === false) { return ''; } $sp3b1dd9 = stripos($spf6683b, $sp5e6650, $sp62a6f7 + strlen($sp51eb65)); if ($sp3b1dd9 === false || $sp62a6f7 >= $sp3b1dd9) { return ''; } $sp0761bc = strlen($sp51eb65); $sp46dd86 = substr($spf6683b, $sp62a6f7 + $sp0761bc, $sp3b1dd9 - $sp62a6f7 - $sp0761bc); return $sp46dd86; } }