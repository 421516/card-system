<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp403bd7) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp403bd7; $this->url_return = SYS_URL . '/pay/return/' . $sp403bd7; } function goPay($sp4d5cc2, $sp2714cc, $spc644e5, $sp5b5e88, $sp9d9f48) { $spb281f4 = strtolower($sp4d5cc2['payway']); if (!isset($sp4d5cc2['id'])) { throw new \Exception('请设置 id'); } $sp8298e9 = array(); if ($spb281f4 == 'qq') { $sp8298e9 = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($spb281f4 == 'alipay') { $sp8298e9 = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $sp2aa970 = ''; $spbaab47 = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $sp4d5cc2['id'] . '&opuid=&reqid=' . $sp2714cc, $sp2aa970, $sp8298e9); $spcfb098 = static::strBetween($spbaab47, 'reqid":"', '"'); $spce37dd = static::strBetween($spbaab47, 'currency":"', '"'); if ($spcfb098 == '' || $spce37dd == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $spbaab47); throw new \Exception('获取支付请求id失败'); } $spfa43a9 = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $sp9d9f48 . '&openid=&appid=&huid=' . $sp4d5cc2['id'] . '&opuid=&reqid=' . $spcfb098 . '&balance=0&currency=' . $spce37dd, $sp2aa970, $sp8298e9); $spc4a98e = json_decode($spfa43a9, true); $sp749f07 = static::strBetween($spfa43a9, 'syssn":"', '"'); if (!$spc4a98e || $sp749f07 == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $spfa43a9); throw new \Exception('生成支付单号失败#1'); } if ($spc4a98e['respcd'] !== '0000') { if (isset($spc4a98e['respmsg']) && $spc4a98e['respmsg'] !== '') { throw new \Exception($spc4a98e['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $spfa43a9); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($sp2714cc)->update(array('pay_trade_no' => $sp749f07)); header('location: /qrcode/pay/' . $sp2714cc . '/qf_' . $spb281f4 . '?url=' . urlencode(json_encode($spc4a98e['data']['pay_params']))); } function verify($sp4d5cc2, $spae1cf8) { $sp804c16 = \App\Order::whereOrderNo($sp4d5cc2['out_trade_no'])->firstOrFail(); $sp749f07 = $sp804c16->pay_trade_no; $spc8bfe1 = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $sp749f07); $spee6439 = json_decode($spc8bfe1, true); if (!$spc8bfe1) { throw new \Exception('query error'); } if (!isset($spee6439['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $spc8bfe1); throw new \Exception('获取支付结果失败'); } if ($spee6439['respcd'] !== '0000') { return false; } $sp05d313 = (int) static::strBetween($spc8bfe1, 'trade_amt":', ','); if ($sp05d313 === 0) { $sp05d313 = (int) static::strBetween($spc8bfe1, 'txamt":', ','); if ($sp05d313 === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $spc8bfe1); throw new \Exception('获取支付金额失败'); } } if ($spee6439['respcd'] === '0000') { $spae1cf8($sp4d5cc2['out_trade_no'], $sp05d313, $sp749f07); return true; } return false; } public static function strBetween($spdeb044, $spbadcf1, $spdd5024) { $sp724aec = stripos($spdeb044, $spbadcf1); if ($sp724aec === false) { return ''; } $sp70d2cb = stripos($spdeb044, $spdd5024, $sp724aec + strlen($spbadcf1)); if ($sp70d2cb === false || $sp724aec >= $sp70d2cb) { return ''; } $spf7e730 = strlen($spbadcf1); $sp123706 = substr($spdeb044, $sp724aec + $spf7e730, $sp70d2cb - $sp724aec - $spf7e730); return $sp123706; } }