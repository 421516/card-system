<?php
namespace App\Library\Pay\Qf; use App\Library\CurlRequest as Request; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spf46c5d) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spf46c5d; $this->url_return = SYS_URL . '/pay/return/' . $spf46c5d; } function goPay($spa9e109, $sp206d07, $sp89af34, $sp92f0c1, $sp28f24f) { $sp266966 = strtolower($spa9e109['payway']); if (!isset($spa9e109['id'])) { throw new \Exception('请设置 id'); } $sp77ba0d = array(); if ($sp266966 == 'qq') { $sp77ba0d = array('User-Agent' => 'Mozilla/5.0 Mobile MQQBrowser/6.2 QQ/7.2.5.3305'); } elseif ($sp266966 == 'alipay') { $sp77ba0d = array('User-Agent' => 'Mozilla/5.0 AlipayChannelId/5136 AlipayDefined(nt:WIFI,ws:411|0|2.625) AliApp(AP/10.1.10.1226101) AlipayClient/10.1.10.1226101'); } $spfe6fd1 = ''; $sp870169 = Request::get('https://o2.qfpay.com/q/info?code=&huid=' . $spa9e109['id'] . '&opuid=&reqid=' . $sp206d07, $spfe6fd1, $sp77ba0d); $sp4e3bc5 = static::str_between($sp870169, 'reqid":"', '"'); $sp6c3c39 = static::str_between($sp870169, 'currency":"', '"'); if ($sp4e3bc5 == '' || $sp6c3c39 == '') { Log::error('qfpay pay, 获取支付金额失败 - ' . $sp870169); throw new \Exception('获取支付请求id失败'); } $sp1c50e5 = Request::post('https://o2.qfpay.com/q/payment', 'txamt=' . $sp28f24f . '&openid=&appid=&huid=' . $spa9e109['id'] . '&opuid=&reqid=' . $sp4e3bc5 . '&balance=0&currency=' . $sp6c3c39, $spfe6fd1, $sp77ba0d); $sp9610ab = json_decode($sp1c50e5, true); $sp6aa194 = static::str_between($sp1c50e5, 'syssn":"', '"'); if (!$sp9610ab || $sp6aa194 == '') { Log::error('qfpay pay, 生成支付单号失败#1 - ' . $sp1c50e5); throw new \Exception('生成支付单号失败#1'); } if ($sp9610ab['respcd'] !== '0000') { if (isset($sp9610ab['respmsg']) && $sp9610ab['respmsg'] !== '') { throw new \Exception($sp9610ab['respmsg']); } Log::error('qfpay pay, 生成支付单号失败#2 - ' . $sp1c50e5); throw new \Exception('生成支付单号失败#2'); } \App\Order::whereOrderNo($sp206d07)->update(array('pay_trade_no' => $sp6aa194)); header('location: /qrcode/pay/' . $sp206d07 . '/qf_' . $sp266966 . '?url=' . urlencode(json_encode($sp9610ab['data']['pay_params']))); } function verify($spa9e109, $spf8927a) { $sp63564c = \App\Order::whereOrderNo($spa9e109['out_trade_no'])->firstOrFail(); $sp6aa194 = $sp63564c->pay_trade_no; $sp035e6d = Request::get('https://marketing.qfpay.com/v1/mkw/activity?syssn=' . $sp6aa194); $spfbb665 = json_decode($sp035e6d, true); if (!$sp035e6d) { throw new \Exception('query error'); } if (!isset($spfbb665['respcd'])) { Log::error('qfpay query, 获取支付结果失败 - ' . $sp035e6d); throw new \Exception('获取支付结果失败'); } if ($spfbb665['respcd'] !== '0000') { return false; } $sp572e49 = (int) static::str_between($sp035e6d, 'trade_amt":', ','); if ($sp572e49 === 0) { $sp572e49 = (int) static::str_between($sp035e6d, 'txamt":', ','); if ($sp572e49 === 0) { Log::error('qfpay query, 获取支付金额失败 - ' . $sp035e6d); throw new \Exception('获取支付金额失败'); } } if ($spfbb665['respcd'] === '0000') { $spf8927a($spa9e109['out_trade_no'], $sp572e49, $sp6aa194); return true; } return false; } public static function str_between($spc940b6, $sp74beb2, $sp04e0f5) { $sp2c0ea6 = stripos($spc940b6, $sp74beb2); if ($sp2c0ea6 === false) { return ''; } $sp5d9f96 = stripos($spc940b6, $sp04e0f5, $sp2c0ea6 + strlen($sp74beb2)); if ($sp5d9f96 === false || $sp2c0ea6 >= $sp5d9f96) { return ''; } $sp7135ea = strlen($sp74beb2); $sp5780b9 = substr($spc940b6, $sp2c0ea6 + $sp7135ea, $sp5d9f96 - $sp2c0ea6 - $sp7135ea); return $sp5780b9; } }