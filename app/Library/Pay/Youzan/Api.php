<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spf46c5d) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spf46c5d; $this->url_return = SYS_URL . '/pay/return/' . $spf46c5d; } private function getAccessToken($spa9e109) { $sp4e66ac = $spa9e109['client_id']; $spf3a703 = $spa9e109['client_secret']; $sp9ceab1 = array('kdt_id' => $spa9e109['kdt_id']); $sp9610ab = (new Open\Token($sp4e66ac, $spf3a703))->getToken('self', $sp9ceab1); if (!isset($sp9610ab['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($sp9610ab)); throw new \Exception('平台支付Token获取失败'); } return $sp9610ab['access_token']; } function goPay($spa9e109, $sp206d07, $sp89af34, $sp92f0c1, $sp28f24f) { $sp266966 = strtolower($spa9e109['payway']); try { $spddf33d = $this->getAccessToken($spa9e109); $spcb0c0f = new Open\Client($spddf33d); } catch (\Exception $sp1b3a33) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $sp1b3a33)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp20678b = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $sp28f24f, 'qr_name' => $sp89af34, 'qr_source' => $sp206d07); $sp9610ab = $spcb0c0f->get('youzan.pay.qrcode.create', '3.0.0', $sp20678b); $sp9610ab = isset($sp9610ab['response']) ? $sp9610ab['response'] : $sp9610ab; if (!isset($sp9610ab['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($sp9610ab)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($sp206d07)->update(array('pay_trade_no' => $sp9610ab['qr_id'])); header('location: /qrcode/pay/' . $sp206d07 . '/youzan_' . strtolower($sp266966) . '?url=' . urlencode($sp9610ab['qr_url'])); die; } function verify($spa9e109, $spf8927a) { $spf53f48 = isset($spa9e109['isNotify']) && $spa9e109['isNotify']; $sp4e66ac = $spa9e109['client_id']; $spf3a703 = $spa9e109['client_secret']; if ($spf53f48) { $spe9da82 = file_get_contents('php://input'); $sp29e0c7 = json_decode($spe9da82, true); if (@$sp29e0c7['test']) { echo 'test success'; return false; } try { $spdfd2b6 = $sp29e0c7['msg']; } catch (\Exception $sp1b3a33) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $sp1b3a33, 'post_raw' => $spe9da82)); echo 'fatal error'; return false; } $sp920e38 = $sp4e66ac . '' . $spdfd2b6 . '' . $spf3a703; $sp9c9a88 = md5($sp920e38); if ($sp9c9a88 != $sp29e0c7['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $sp920e38 . ', $sign' . $sp9c9a88); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $spdfd2b6 = json_decode(urldecode($spdfd2b6), true); if ($sp29e0c7['type'] === 'TRADE_ORDER_STATE' && $spdfd2b6['status'] === 'TRADE_SUCCESS') { try { $spddf33d = $this->getAccessToken($spa9e109); $spcb0c0f = new Open\Client($spddf33d); } catch (\Exception $sp1b3a33) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $sp1b3a33)); echo 'fatal error'; return false; } $sp20678b = array('tid' => $spdfd2b6['tid']); $sp9610ab = $spcb0c0f->get('youzan.trade.get', '3.0.0', $sp20678b); if (isset($sp9610ab['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $sp9610ab['error_response']['msg']); echo 'fatal error'; return false; } $spb0291f = $sp9610ab['response']['trade']; $sp63564c = \App\Order::where('pay_trade_no', $spb0291f['qr_id'])->first(); if ($sp63564c) { $sp3bdfdc = $spdfd2b6['tid']; $spf8927a($sp63564c->order_no, (int) round($spb0291f['payment'] * 100), $sp3bdfdc); } } return true; } else { $sp206d07 = @$spa9e109['out_trade_no']; if (strlen($sp206d07) < 5) { throw new \Exception('交易单号未传入'); } $sp63564c = \App\Order::whereOrderNo($sp206d07)->firstOrFail(); if (!$sp63564c->pay_trade_no || !strlen($sp63564c->pay_trade_no)) { return false; } try { $spddf33d = $this->getAccessToken($spa9e109); $spcb0c0f = new Open\Client($spddf33d); } catch (\Exception $sp1b3a33) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $sp1b3a33)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp20678b = array('qr_id' => $sp63564c->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $sp9610ab = $spcb0c0f->get('youzan.trades.qr.get', '3.0.0', $sp20678b); $spaef587 = isset($sp9610ab['response']) ? $sp9610ab['response'] : $sp9610ab; if (!isset($spaef587['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $sp9610ab)); return false; } if ($spaef587['total_results'] > 0 && count($spaef587['qr_trades']) > 0 && isset($spaef587['qr_trades'][0]['qr_id']) && $spaef587['qr_trades'][0]['qr_id'] === $sp63564c->pay_trade_no) { $sp6c476d = $spaef587['qr_trades'][0]; $sp3bdfdc = $sp6c476d['tid']; $spf8927a($sp206d07, (int) round($sp6c476d['real_price'] * 100), $sp3bdfdc); return true; } else { return false; } } } }