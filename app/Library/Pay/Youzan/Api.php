<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3a2be3) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3a2be3; $this->url_return = SYS_URL . '/pay/return/' . $sp3a2be3; } private function getAccessToken($sp45b2a0) { $sp117b5d = $sp45b2a0['client_id']; $sp7a1ff6 = $sp45b2a0['client_secret']; $spca929e = array('kdt_id' => $sp45b2a0['kdt_id']); $spcc4042 = (new Open\Token($sp117b5d, $sp7a1ff6))->getToken('self', $spca929e); if (!isset($spcc4042['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($spcc4042)); throw new \Exception('平台支付Token获取失败'); } return $spcc4042['access_token']; } function goPay($sp45b2a0, $spd184e1, $sp873da9, $sp33eb4d, $sp521b2c) { $spa27512 = strtolower($sp45b2a0['payway']); try { $sp49c28b = $this->getAccessToken($sp45b2a0); $sp589946 = new Open\Client($sp49c28b); } catch (\Exception $sp805d3e) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $sp805d3e)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $spf44b7f = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $sp521b2c, 'qr_name' => $sp873da9, 'qr_source' => $spd184e1); $spcc4042 = $sp589946->get('youzan.pay.qrcode.create', '3.0.0', $spf44b7f); $spcc4042 = isset($spcc4042['response']) ? $spcc4042['response'] : $spcc4042; if (!isset($spcc4042['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($spcc4042)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($spd184e1)->update(array('pay_trade_no' => $spcc4042['qr_id'])); header('location: /qrcode/pay/' . $spd184e1 . '/youzan_' . strtolower($spa27512) . '?url=' . urlencode($spcc4042['qr_url'])); die; } function verify($sp45b2a0, $spf85c0e) { $sp5c8ce2 = isset($sp45b2a0['isNotify']) && $sp45b2a0['isNotify']; $sp117b5d = $sp45b2a0['client_id']; $sp7a1ff6 = $sp45b2a0['client_secret']; if ($sp5c8ce2) { $sp626522 = file_get_contents('php://input'); $sp38c5ae = json_decode($sp626522, true); if (@$sp38c5ae['test']) { echo 'test success'; return false; } try { $sp3792af = $sp38c5ae['msg']; } catch (\Exception $sp805d3e) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $sp805d3e, 'post_raw' => $sp626522)); echo 'fatal error'; return false; } $sp91e0a4 = $sp117b5d . '' . $sp3792af . '' . $sp7a1ff6; $sp885ea3 = md5($sp91e0a4); if ($sp885ea3 != $sp38c5ae['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $sp91e0a4 . ', $sign' . $sp885ea3); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $sp3792af = json_decode(urldecode($sp3792af), true); if ($sp38c5ae['type'] === 'TRADE_ORDER_STATE' && $sp3792af['status'] === 'TRADE_SUCCESS') { try { $sp49c28b = $this->getAccessToken($sp45b2a0); $sp589946 = new Open\Client($sp49c28b); } catch (\Exception $sp805d3e) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $sp805d3e)); echo 'fatal error'; return false; } $spf44b7f = array('tid' => $sp3792af['tid']); $spcc4042 = $sp589946->get('youzan.trade.get', '3.0.0', $spf44b7f); if (isset($spcc4042['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $spcc4042['error_response']['msg']); echo 'fatal error'; return false; } $sp0285e0 = $spcc4042['response']['trade']; $spc9222b = \App\Order::where('pay_trade_no', $sp0285e0['qr_id'])->first(); if ($spc9222b) { $sp278aa9 = $sp3792af['tid']; $spf85c0e($spc9222b->order_no, intval($sp0285e0['payment'] * 100), $sp278aa9); } } return true; } else { $spd184e1 = @$sp45b2a0['out_trade_no']; if (strlen($spd184e1) < 5) { throw new \Exception('交易单号未传入'); } $spc9222b = \App\Order::whereOrderNo($spd184e1)->firstOrFail(); if (!$spc9222b->pay_trade_no || !strlen($spc9222b->pay_trade_no)) { return false; } try { $sp49c28b = $this->getAccessToken($sp45b2a0); $sp589946 = new Open\Client($sp49c28b); } catch (\Exception $sp805d3e) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $sp805d3e)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $spf44b7f = array('qr_id' => $spc9222b->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $spcc4042 = $sp589946->get('youzan.trades.qr.get', '3.0.0', $spf44b7f); $spa08416 = isset($spcc4042['response']) ? $spcc4042['response'] : $spcc4042; if (!isset($spa08416['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $spcc4042)); return false; } if ($spa08416['total_results'] > 0 && count($spa08416['qr_trades']) > 0 && isset($spa08416['qr_trades'][0]['qr_id']) && $spa08416['qr_trades'][0]['qr_id'] === $spc9222b->pay_trade_no) { $sp3f83b4 = $spa08416['qr_trades'][0]; $sp278aa9 = $sp3f83b4['tid']; $spf85c0e($spd184e1, intval($sp3f83b4['real_price'] * 100), $sp278aa9); return true; } else { return false; } } } }