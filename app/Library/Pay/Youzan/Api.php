<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe6149b) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe6149b; $this->url_return = SYS_URL . '/pay/return/' . $spe6149b; } private function getAccessToken($spd82bcd) { $sp2dc34d = $spd82bcd['client_id']; $sp01a0af = $spd82bcd['client_secret']; $spa3a035 = array('kdt_id' => $spd82bcd['kdt_id']); $sp836ce6 = (new Open\Token($sp2dc34d, $sp01a0af))->getToken('self', $spa3a035); if (!isset($sp836ce6['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($sp836ce6)); throw new \Exception('平台支付Token获取失败'); } return $sp836ce6['access_token']; } function goPay($spd82bcd, $sp6281ad, $spe4243d, $sp1d246b, $sp54eead) { $spabb601 = strtolower($spd82bcd['payway']); try { $spfab834 = $this->getAccessToken($spd82bcd); $spd272b0 = new Open\Client($spfab834); } catch (\Exception $spfda1c7) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $spfda1c7)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp31ee10 = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $sp54eead, 'qr_name' => $spe4243d, 'qr_source' => $sp6281ad); $sp836ce6 = $spd272b0->get('youzan.pay.qrcode.create', '3.0.0', $sp31ee10); $sp836ce6 = isset($sp836ce6['response']) ? $sp836ce6['response'] : $sp836ce6; if (!isset($sp836ce6['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($sp836ce6)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($sp6281ad)->update(array('pay_trade_no' => $sp836ce6['qr_id'])); header('location: /qrcode/pay/' . $sp6281ad . '/youzan_' . strtolower($spabb601) . '?url=' . urlencode($sp836ce6['qr_url'])); die; } function verify($spd82bcd, $spbb5f38) { $spe16bd1 = isset($spd82bcd['isNotify']) && $spd82bcd['isNotify']; $sp2dc34d = $spd82bcd['client_id']; $sp01a0af = $spd82bcd['client_secret']; if ($spe16bd1) { $sp1bbbde = file_get_contents('php://input'); $sp94131d = json_decode($sp1bbbde, true); if (@$sp94131d['test']) { echo 'test success'; return false; } try { $spcb569a = $sp94131d['msg']; } catch (\Exception $spfda1c7) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $spfda1c7, 'post_raw' => $sp1bbbde)); echo 'fatal error'; return false; } $spc26476 = $sp2dc34d . '' . $spcb569a . '' . $sp01a0af; $sp36c1ea = md5($spc26476); if ($sp36c1ea != $sp94131d['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $spc26476 . ', $sign' . $sp36c1ea); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $spcb569a = json_decode(urldecode($spcb569a), true); if ($sp94131d['type'] === 'TRADE_ORDER_STATE' && $spcb569a['status'] === 'TRADE_SUCCESS') { try { $spfab834 = $this->getAccessToken($spd82bcd); $spd272b0 = new Open\Client($spfab834); } catch (\Exception $spfda1c7) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $spfda1c7)); echo 'fatal error'; return false; } $sp31ee10 = array('tid' => $spcb569a['tid']); $sp836ce6 = $spd272b0->get('youzan.trade.get', '3.0.0', $sp31ee10); if (isset($sp836ce6['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $sp836ce6['error_response']['msg']); echo 'fatal error'; return false; } $sp30c9e5 = $sp836ce6['response']['trade']; $sp33b59d = \App\Order::where('pay_trade_no', $sp30c9e5['qr_id'])->first(); if ($sp33b59d) { $spfcfc25 = $spcb569a['tid']; $spbb5f38($sp33b59d->order_no, intval($sp30c9e5['payment'] * 100), $spfcfc25); } } return true; } else { $sp6281ad = @$spd82bcd['out_trade_no']; if (strlen($sp6281ad) < 5) { throw new \Exception('交易单号未传入'); } $sp33b59d = \App\Order::whereOrderNo($sp6281ad)->firstOrFail(); if (!$sp33b59d->pay_trade_no || !strlen($sp33b59d->pay_trade_no)) { return false; } try { $spfab834 = $this->getAccessToken($spd82bcd); $spd272b0 = new Open\Client($spfab834); } catch (\Exception $spfda1c7) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $spfda1c7)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp31ee10 = array('qr_id' => $sp33b59d->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $sp836ce6 = $spd272b0->get('youzan.trades.qr.get', '3.0.0', $sp31ee10); $sp8a6c13 = isset($sp836ce6['response']) ? $sp836ce6['response'] : $sp836ce6; if (!isset($sp8a6c13['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $sp836ce6)); return false; } if ($sp8a6c13['total_results'] > 0 && count($sp8a6c13['qr_trades']) > 0 && isset($sp8a6c13['qr_trades'][0]['qr_id']) && $sp8a6c13['qr_trades'][0]['qr_id'] === $sp33b59d->pay_trade_no) { $sp969aaf = $sp8a6c13['qr_trades'][0]; $spfcfc25 = $sp969aaf['tid']; $spbb5f38($sp6281ad, intval($sp969aaf['real_price'] * 100), $spfcfc25); return true; } else { return false; } } } }