<?php
namespace App\Library\Pay\Youzan; use App\Library\Pay\ApiInterface; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp403bd7) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp403bd7; $this->url_return = SYS_URL . '/pay/return/' . $sp403bd7; } private function getAccessToken($sp4d5cc2) { $spe0b5ac = $sp4d5cc2['client_id']; $sp8937ab = $sp4d5cc2['client_secret']; $sp200c8e = array('kdt_id' => $sp4d5cc2['kdt_id']); $spc4a98e = (new Open\Token($spe0b5ac, $sp8937ab))->getToken('self', $sp200c8e); if (!isset($spc4a98e['access_token'])) { \Log::error('Pay.Youzan.goPay.getToken Error: ' . json_encode($spc4a98e)); throw new \Exception('平台支付Token获取失败'); } return $spc4a98e['access_token']; } function goPay($sp4d5cc2, $sp2714cc, $spc644e5, $sp5b5e88, $sp9d9f48) { $spb281f4 = strtolower($sp4d5cc2['payway']); try { $sp8ef764 = $this->getAccessToken($sp4d5cc2); $sp6684ba = new Open\Client($sp8ef764); } catch (\Exception $sp9e5801) { \Log::error('Pay.Youzan.goPay getAccessToken error', array('exception' => $sp9e5801)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp50fc45 = array('qr_type' => 'QR_TYPE_DYNAMIC', 'qr_price' => $sp9d9f48, 'qr_name' => $spc644e5, 'qr_source' => $sp2714cc); $spc4a98e = $sp6684ba->get('youzan.pay.qrcode.create', '3.0.0', $sp50fc45); $spc4a98e = isset($spc4a98e['response']) ? $spc4a98e['response'] : $spc4a98e; if (!isset($spc4a98e['qr_url'])) { \Log::error('Pay.Youzan.goPay.getQrcode Error: ' . json_encode($spc4a98e)); throw new \Exception('平台支付二维码获取失败'); } \App\Order::whereOrderNo($sp2714cc)->update(array('pay_trade_no' => $spc4a98e['qr_id'])); header('location: /qrcode/pay/' . $sp2714cc . '/youzan_' . strtolower($spb281f4) . '?url=' . urlencode($spc4a98e['qr_url'])); die; } function verify($sp4d5cc2, $spae1cf8) { $sp5c532f = isset($sp4d5cc2['isNotify']) && $sp4d5cc2['isNotify']; $spe0b5ac = $sp4d5cc2['client_id']; $sp8937ab = $sp4d5cc2['client_secret']; if ($sp5c532f) { $spf51b9b = file_get_contents('php://input'); $sp151100 = json_decode($spf51b9b, true); if (@$sp151100['test']) { echo 'test success'; return false; } try { $sp55c6db = $sp151100['msg']; } catch (\Exception $sp9e5801) { \Log::error('Pay.Youzan.verify get input error#1', array('exception' => $sp9e5801, 'post_raw' => $spf51b9b)); echo 'fatal error'; return false; } $sp9c7f5b = $spe0b5ac . '' . $sp55c6db . '' . $sp8937ab; $sp26d1d6 = md5($sp9c7f5b); if ($sp26d1d6 != $sp151100['sign']) { \Log::error('Pay.Youzan.verify, sign error $sign_string:' . $sp9c7f5b . ', $sign' . $sp26d1d6); echo 'fatal error'; return false; } else { echo json_encode(array('code' => 0, 'msg' => 'success')); } $sp55c6db = json_decode(urldecode($sp55c6db), true); if ($sp151100['type'] === 'TRADE_ORDER_STATE' && $sp55c6db['status'] === 'TRADE_SUCCESS') { try { $sp8ef764 = $this->getAccessToken($sp4d5cc2); $sp6684ba = new Open\Client($sp8ef764); } catch (\Exception $sp9e5801) { \Log::error('Pay.Youzan.verify getAccessToken error#1', array('exception' => $sp9e5801)); echo 'fatal error'; return false; } $sp50fc45 = array('tid' => $sp55c6db['tid']); $spc4a98e = $sp6684ba->get('youzan.trade.get', '3.0.0', $sp50fc45); if (isset($spc4a98e['error_response'])) { \Log::error('Pay.Youzan.verify with error：' . $spc4a98e['error_response']['msg']); echo 'fatal error'; return false; } $sp88295a = $spc4a98e['response']['trade']; $sp804c16 = \App\Order::where('pay_trade_no', $sp88295a['qr_id'])->first(); if ($sp804c16) { $sp77d87b = $sp55c6db['tid']; $spae1cf8($sp804c16->order_no, intval($sp88295a['payment'] * 100), $sp77d87b); } } return true; } else { $sp2714cc = @$sp4d5cc2['out_trade_no']; if (strlen($sp2714cc) < 5) { throw new \Exception('交易单号未传入'); } $sp804c16 = \App\Order::whereOrderNo($sp2714cc)->firstOrFail(); if (!$sp804c16->pay_trade_no || !strlen($sp804c16->pay_trade_no)) { return false; } try { $sp8ef764 = $this->getAccessToken($sp4d5cc2); $sp6684ba = new Open\Client($sp8ef764); } catch (\Exception $sp9e5801) { \Log::error('Pay.Youzan.verify getAccessToken error#2', array('exception' => $sp9e5801)); throw new \Exception('支付渠道响应超时，请刷新重试'); } $sp50fc45 = array('qr_id' => $sp804c16->pay_trade_no, 'status' => 'TRADE_RECEIVED'); $spc4a98e = $sp6684ba->get('youzan.trades.qr.get', '3.0.0', $sp50fc45); $sp9c6359 = isset($spc4a98e['response']) ? $spc4a98e['response'] : $spc4a98e; if (!isset($sp9c6359['total_results'])) { \Log::error('Pay.Youzan.verify with error：The result of [youzan.trades.qr.get] has no key named [total_results]', array('result' => $spc4a98e)); return false; } if ($sp9c6359['total_results'] > 0 && count($sp9c6359['qr_trades']) > 0 && isset($sp9c6359['qr_trades'][0]['qr_id']) && $sp9c6359['qr_trades'][0]['qr_id'] === $sp804c16->pay_trade_no) { $sp7bfe23 = $sp9c6359['qr_trades'][0]; $sp77d87b = $sp7bfe23['tid']; $spae1cf8($sp2714cc, intval($sp7bfe23['real_price'] * 100), $sp77d87b); return true; } else { return false; } } } }