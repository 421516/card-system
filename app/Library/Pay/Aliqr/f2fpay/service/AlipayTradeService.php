<?php
require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . './../../AopSdk.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . './../model/result/AlipayF2FPayResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FQueryResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FRefundResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/result/AlipayF2FPrecreateResult.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/builder/AlipayTradeQueryContentBuilder.php'; require_once dirname(__FILE__) . DIRECTORY_SEPARATOR . '../model/builder/AlipayTradeCancelContentBuilder.php'; require dirname(__FILE__) . DIRECTORY_SEPARATOR . '../config/config.php'; class AlipayTradeService { public $gateway_url = 'https://openapi.alipay.com/gateway.do'; public $notify_url; public $sign_type; public $alipay_public_key; public $private_key; public $appid; public $charset = 'UTF-8'; public $token = NULL; private $MaxQueryRetry; private $QueryDuration; public $format = 'json'; function __construct($sp233f0d) { $this->gateway_url = $sp233f0d['gatewayUrl']; $this->appid = $sp233f0d['app_id']; $this->sign_type = $sp233f0d['sign_type']; $this->private_key = $sp233f0d['merchant_private_key']; $this->alipay_public_key = $sp233f0d['alipay_public_key']; $this->charset = $sp233f0d['charset']; $this->MaxQueryRetry = $sp233f0d['MaxQueryRetry']; $this->QueryDuration = $sp233f0d['QueryDuration']; $this->notify_url = $sp233f0d['notify_url']; if (empty($this->appid) || trim($this->appid) == '') { throw new Exception('appid should not be NULL!'); } if (empty($this->private_key) || trim($this->private_key) == '') { throw new Exception('private_key should not be NULL!'); } if (empty($this->alipay_public_key) || trim($this->alipay_public_key) == '') { throw new Exception('alipay_public_key should not be NULL!'); } if (empty($this->charset) || trim($this->charset) == '') { throw new Exception('charset should not be NULL!'); } if (empty($this->QueryDuration) || trim($this->QueryDuration) == '') { throw new Exception('QueryDuration should not be NULL!'); } if (empty($this->gateway_url) || trim($this->gateway_url) == '') { throw new Exception('gateway_url should not be NULL!'); } if (empty($this->MaxQueryRetry) || trim($this->MaxQueryRetry) == '') { throw new Exception('MaxQueryRetry should not be NULL!'); } if (empty($this->sign_type) || trim($this->sign_type) == '') { throw new Exception('sign_type should not be NULL'); } } function AlipayWapPayService($sp233f0d) { $this->__construct($sp233f0d); } public function barPay($sp62eb9d) { $spa74ea9 = $sp62eb9d->getOutTradeNo(); $spd4f863 = $sp62eb9d->getBizContent(); $sp114e2c = $sp62eb9d->getAppAuthToken(); $this->writeLog($spd4f863); $spdd9f33 = new AlipayTradePayRequest(); $spdd9f33->setBizContent($spd4f863); $sp1de750 = $this->aopclientRequestExecute($spdd9f33, NULL, $sp114e2c); $sp1de750 = $sp1de750->alipay_trade_pay_response; $spc4a98e = new AlipayF2FPayResult($sp1de750); if (!empty($sp1de750) && '10000' == $sp1de750->code) { $spc4a98e->setTradeStatus('SUCCESS'); } elseif (!empty($sp1de750) && '10003' == $sp1de750->code) { $sp5b97ca = new AlipayTradeQueryContentBuilder(); $sp5b97ca->setOutTradeNo($spa74ea9); $sp5b97ca->setAppAuthToken($sp114e2c); $sp1782a1 = $this->loopQueryResult($sp5b97ca); return $this->checkQueryAndCancel($spa74ea9, $sp114e2c, $spc4a98e, $sp1782a1); } elseif ($this->tradeError($sp1de750)) { $sp5b97ca = new AlipayTradeQueryContentBuilder(); $sp5b97ca->setOutTradeNo($spa74ea9); $sp5b97ca->setAppAuthToken($sp114e2c); $sp899346 = $this->query($sp5b97ca); return $this->checkQueryAndCancel($spa74ea9, $sp114e2c, $spc4a98e, $sp899346); } else { $spc4a98e->setTradeStatus('FAILED'); } return $spc4a98e; } public function queryTradeResult($sp62eb9d) { $sp1de750 = $this->query($sp62eb9d); $spc4a98e = new AlipayF2FQueryResult($sp1de750); if ($this->querySuccess($sp1de750)) { $spc4a98e->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($sp1de750)) { $spc4a98e->setTradeStatus('UNKNOWN'); } else { $spc4a98e->setTradeStatus('FAILED'); } return $spc4a98e; } public function refund($sp62eb9d) { $spd4f863 = $sp62eb9d->getBizContent(); $this->writeLog($spd4f863); $spdd9f33 = new AlipayTradeRefundRequest(); $spdd9f33->setBizContent($spd4f863); $sp1de750 = $this->aopclientRequestExecute($spdd9f33, NULL, $sp62eb9d->getAppAuthToken()); $sp1de750 = $sp1de750->alipay_trade_refund_response; $spc4a98e = new AlipayF2FRefundResult($sp1de750); if (!empty($sp1de750) && '10000' == $sp1de750->code) { $spc4a98e->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($sp1de750)) { $spc4a98e->setTradeStatus('UNKNOWN'); } else { $spc4a98e->setTradeStatus('FAILED'); } return $spc4a98e; } public function qrPay($sp62eb9d) { $spd4f863 = $sp62eb9d->getBizContent(); $this->writeLog($spd4f863); $spdd9f33 = new AlipayTradePrecreateRequest(); $spdd9f33->setBizContent($spd4f863); $spdd9f33->setNotifyUrl($this->notify_url); $sp1de750 = $this->aopclientRequestExecute($spdd9f33, NULL, $sp62eb9d->getAppAuthToken()); $sp1de750 = $sp1de750->alipay_trade_precreate_response; $spc4a98e = new AlipayF2FPrecreateResult($sp1de750); if (!empty($sp1de750) && '10000' == $sp1de750->code) { $spc4a98e->setTradeStatus('SUCCESS'); } elseif ($this->tradeError($sp1de750)) { $spc4a98e->setTradeStatus('UNKNOWN'); } else { $spc4a98e->setTradeStatus('FAILED'); } return $spc4a98e; } public function query($sp5b97ca) { $spde148a = $sp5b97ca->getBizContent(); $this->writeLog($spde148a); $spdd9f33 = new AlipayTradeQueryRequest(); $spdd9f33->setBizContent($spde148a); $sp1de750 = $this->aopclientRequestExecute($spdd9f33, NULL, $sp5b97ca->getAppAuthToken()); return $sp1de750->alipay_trade_query_response; } protected function loopQueryResult($sp5b97ca) { $sp5cc245 = NULL; for ($spfae064 = 1; $spfae064 < $this->MaxQueryRetry; $spfae064++) { try { sleep($this->QueryDuration); } catch (Exception $sp9e5801) { print $sp9e5801->getMessage(); die; } $sp899346 = $this->query($sp5b97ca); if (!empty($sp899346)) { if ($this->stopQuery($sp899346)) { return $sp899346; } $sp5cc245 = $sp899346; } } return $sp5cc245; } protected function stopQuery($sp1de750) { if ('10000' == $sp1de750->code) { if ('TRADE_FINISHED' == $sp1de750->trade_status || 'TRADE_SUCCESS' == $sp1de750->trade_status || 'TRADE_CLOSED' == $sp1de750->trade_status) { return true; } } return false; } private function checkQueryAndCancel($spa74ea9, $sp114e2c, $spc4a98e, $sp899346) { if ($this->querySuccess($sp899346)) { $spc4a98e->setTradeStatus('SUCCESS'); $spc4a98e->setResponse($sp899346); return $spc4a98e; } elseif ($this->queryClose($sp899346)) { $spc4a98e->setTradeStatus('FAILED'); return $spc4a98e; } $sp62a91c = new AlipayTradeCancelContentBuilder(); $sp62a91c->setAppAuthToken($sp114e2c); $sp62a91c->setOutTradeNo($spa74ea9); $spdc8aca = $this->cancel($sp62a91c); if ($this->tradeError($spdc8aca)) { $spc4a98e->setTradeStatus('UNKNOWN'); } else { $spc4a98e->setTradeStatus('FAILED'); } return $spc4a98e; } protected function querySuccess($sp899346) { return !empty($sp899346) && $sp899346->code == '10000' && ($sp899346->trade_status == 'TRADE_SUCCESS' || $sp899346->trade_status == 'TRADE_FINISHED'); } protected function queryClose($sp899346) { return !empty($sp899346) && $sp899346->code == '10000' && $sp899346->trade_status == 'TRADE_CLOSED'; } protected function tradeError($sp1de750) { return empty($sp1de750) || $sp1de750->code == '20000'; } public function cancel($sp62a91c) { $spde148a = $sp62a91c->getBizContent(); $this->writeLog($spde148a); $spdd9f33 = new AlipayTradeCancelRequest(); $spdd9f33->setBizContent($spde148a); $sp1de750 = $this->aopclientRequestExecute($spdd9f33, NULL, $sp62a91c->getAppAuthToken()); return $sp1de750->alipay_trade_cancel_response; } private function aopclientRequestExecute($spdd9f33, $sp09386b = NULL, $sp114e2c = NULL) { $sp9f2e34 = new AopClient(); $sp9f2e34->gatewayUrl = $this->gateway_url; $sp9f2e34->appId = $this->appid; $sp9f2e34->signType = $this->sign_type; $sp9f2e34->rsaPrivateKey = $this->private_key; $sp9f2e34->alipayrsaPublicKey = $this->alipay_public_key; $sp9f2e34->apiVersion = '1.0'; $sp9f2e34->postCharset = $this->charset; $sp9f2e34->format = $this->format; $sp9f2e34->debugInfo = true; $spc4a98e = $sp9f2e34->execute($spdd9f33, $sp09386b, $sp114e2c); return $spc4a98e; } function writeLog($sp3dccb7) { file_put_contents(dirname(__FILE__) . '/../log/log.txt', date('Y-m-d H:i:s') . '  ' . $sp3dccb7 . '
', FILE_APPEND); } function create_erweima($sp05263d, $spe9007c = '200', $spea8bb3 = 'L', $spf2245b = '0') { $sp05263d = urlencode($sp05263d); $spdfabf7 = '<img src="http://chart.apis.google.com/chart?chs=' . $spe9007c . 'x' . $spe9007c . '&amp;cht=qr&chld=' . $spea8bb3 . '|' . $spf2245b . '&amp;chl=' . $sp05263d . '"  widht="' . $spe9007c . '" height="' . $spe9007c . '" />'; return $spdfabf7; } function create_erweima_url($sp05263d, $spe9007c = '200', $spea8bb3 = 'L', $spf2245b = '0') { $sp05263d = urlencode($sp05263d); $spdfabf7 = 'http://chart.apis.google.com/chart?chs=' . $spe9007c . 'x' . $spe9007c . '&amp;cht=qr&chld=' . $spea8bb3 . '|' . $spf2245b . '&amp;chl=' . $sp05263d; return $spdfabf7; } }