<?php
namespace App\Library\Pay\QweBank; use App\Library\CurlRequest; use App\Library\Helper; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spf46c5d) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spf46c5d; $this->url_return = SYS_URL . '/pay/return/' . $spf46c5d; } function getAccessToken($spa9e109) { $sp768a10 = str_random(5); $sp6a84b5 = time() . '00'; $sp9c9a88 = strtoupper(md5('merchantNo=' . $spa9e109['mchid'] . '&nonce=' . $sp768a10 . '&timestamp=' . $sp6a84b5 . '&key=' . $spa9e109['key'])); $sp20678b = json_encode(array('merchantNo' => $spa9e109['mchid'], 'key' => $spa9e109['key'], 'nonce' => $sp768a10, 'timestamp' => $sp6a84b5, 'sign' => $sp9c9a88), JSON_FORCE_OBJECT); $spfe6fd1 = ''; $sp177bbf = CurlRequest::post('http://api.qwebank.top/open/v1/getAccessToken/merchant', $sp20678b, $spfe6fd1, array('Content-Type' => 'application/json')); $sp5780b9 = @json_decode($sp177bbf, true); if (!is_array($sp5780b9) || !isset($sp5780b9['value']) || !isset($sp5780b9['value']['accessToken'])) { Log::error('Pay.QweBank.getAccessToken Error: ' . $sp177bbf); throw new \Exception('获取支付渠道失败，请联系客服反馈'); } return $sp5780b9['value']['accessToken']; } function goPay($spa9e109, $sp206d07, $sp89af34, $sp92f0c1, $sp28f24f) { if (!isset($spa9e109['mchid'])) { throw new \Exception('请填写 mchid'); } if (!isset($spa9e109['key'])) { throw new \Exception('请填写 key'); } $sp651d92 = $spa9e109['payway']; $sp20678b = array('accessToken' => $this->getAccessToken($spa9e109), 'param' => array('outTradeNo' => $sp206d07, 'money' => $sp28f24f, 'type' => 'T0', 'body' => $sp89af34, 'detail' => $sp89af34, 'notifyUrl' => $this->url_notify, 'successUrl' => $this->url_return, 'productId' => '12313', 'timestamp' => strval(time()), 'sign' => '1')); if ($sp651d92 === 'wechatWapPay') { $sp20678b['param']['merchantIp'] = Helper::getIP(); } if ($sp651d92 === 'bankPay') { if (!isset($spa9e109['bankName'])) { throw new \Exception('请填写 bankName'); } $sp20678b['param']['bankName'] = $spa9e109['bankName']; } $spfe6fd1 = ''; $sp177bbf = CurlRequest::post('http://api.qwebank.top/open/v1/order/' . $sp651d92, json_encode($sp20678b, JSON_FORCE_OBJECT), $spfe6fd1, array('Content-Type' => 'application/json')); $sp5780b9 = @json_decode($sp177bbf, true); if (!is_array($sp5780b9) || !isset($sp5780b9['success']) || !isset($sp5780b9['value'])) { Log::error('Pay.QweBank.goPay Error: ' . $sp177bbf); throw new \Exception('提交订单到支付渠道失败，请联系客服反馈'); } header('Location: ' . $sp5780b9['value']); die; } function verify($spa9e109, $spf8927a) { $spf53f48 = isset($spa9e109['isNotify']) && $spa9e109['isNotify']; $sp9610ab = false; if ($spf53f48) { $spc940b6 = 'merchantNo=' . $_REQUEST['merchantNo'] . '&no=' . $_REQUEST['no'] . '&nonce=' . $_REQUEST['nonce'] . '&timestamp=' . $_REQUEST['timestamp'] . '&key=' . $spa9e109['key']; if (md5($spc940b6) !== $_REQUEST['sign']) { $sp9610ab = true; } echo $sp9610ab ? 'SUCCESS' : 'fail'; } else { $sp206d07 = $_REQUEST['outTradeNo']; $sp20678b = array('accessToken' => $this->getAccessToken($spa9e109), 'param' => $sp206d07); $spfe6fd1 = ''; $sp177bbf = CurlRequest::post('http://api.qwebank.top/open/v1/order/getByCustomerNo', json_encode($sp20678b, JSON_FORCE_OBJECT), $spfe6fd1, array('Content-Type' => 'application/json')); $sp5780b9 = @json_decode($sp177bbf, true); if (!is_array($sp5780b9) || !isset($sp5780b9['success']) || !isset($sp5780b9['value'])) { Log::error('Pay.QweBank.verify.getByCustomerNo Error: ' . $sp177bbf); return false; } $sp9610ab = $sp5780b9['value']['done'] === true; } if ($sp9610ab) { $sp206d07 = $_REQUEST['outTradeNo']; $spbc3979 = $_REQUEST['money']; $spa5c5e7 = $_REQUEST['no']; $spf8927a($sp206d07, $spbc3979, $spa5c5e7); return true; } return false; } }