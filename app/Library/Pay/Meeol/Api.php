<?php
namespace App\Library\Pay\Meeol; use App\Library\CurlRequest; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spf46c5d) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spf46c5d; $this->url_return = SYS_URL . '/pay/return/' . $spf46c5d; } function goPay($spa9e109, $sp206d07, $sp89af34, $sp92f0c1, $sp28f24f) { $spbc3979 = sprintf('%.2f', $sp28f24f / 100); if (!isset($spa9e109['appId'])) { throw new \Exception('请设置appId'); } if (!isset($spa9e109['key'])) { throw new \Exception('请设置key'); } $sp651d92 = $spa9e109['payway']; $sp4e35b4 = array('amount' => $spbc3979, 'appId' => $spa9e109['appId'], 'orderId' => $sp206d07, 'random' => md5(random_bytes(16)), 'tradeType' => $sp651d92); $sp4e35b4['sign'] = strtoupper(md5('amount=' . $sp4e35b4['amount'] . '&appId=' . $spa9e109['appId'] . '&key=' . $spa9e109['key'] . '&orderId=' . $sp4e35b4['orderId'] . '&random=' . $sp4e35b4['random'] . '&tradeType=' . $sp4e35b4['tradeType'])); $sp177bbf = CurlRequest::post('http://api.meeol.cn/rest/mall/payment/order', json_encode($sp4e35b4)); $sp5780b9 = json_decode($sp177bbf, true); if (!isset($sp5780b9['status']) || $sp5780b9['status'] !== '0') { Log::error('Pay.Meeol.goPay.order Error: ' . $sp177bbf); throw new \Exception('支付请求失败, 请刷新重试'); } if (substr($sp651d92, 0, 1) === 'W') { header('Location: /qrcode/pay/' . $sp206d07 . '/wechat?url=' . urlencode($sp5780b9['qrcode'])); } elseif (substr($sp651d92, 0, 1) === 'A') { header('Location: /qrcode/pay/' . $sp206d07 . '/aliqr?url=' . urlencode($sp5780b9['qrcode'])); } die; } function verify($spa9e109, $spf8927a) { $spf53f48 = isset($spa9e109['isNotify']) && $spa9e109['isNotify']; if ($spf53f48) { $sp4488da = json_decode(file_get_contents('php://input'), true); $sp9c9a88 = strtoupper(md5('amount=' . $sp4488da['amount'] . '&appid=' . $sp4488da['appid'] . '&key=' . $spa9e109['key'] . '&orderId=' . $sp4488da['orderId'] . '&tradeTime=' . $sp4488da['tradeTime'] . '&tradeType=' . $sp4488da['tradeType'])); if ($sp9c9a88 === $sp4488da['sign']) { $spbc3979 = (int) round($sp4488da['amount'] * 100); $spf8927a($sp4488da['orderId'], $spbc3979, $sp4488da['passTradeNo']); echo 'success'; return true; } else { Log::error('Pay.Meeol.verify notify sign error, post: ' . file_get_contents('php://input')); echo 'error'; } } else { if (!empty($spa9e109['out_trade_no'])) { $sp4e35b4 = array('appId' => $spa9e109['appId'], 'orderId' => $spa9e109['out_trade_no'], 'random' => md5(random_bytes(16))); $sp4e35b4['sign'] = strtoupper(md5('appId=' . $spa9e109['appId'] . '&key=' . $spa9e109['key'] . '&orderId=' . $sp4e35b4['orderId'] . '&random=' . $sp4e35b4['random'])); $sp4e35b4 = json_encode($sp4e35b4); $sp177bbf = CurlRequest::post('http://api.meeol.cn/rest/mall/payment/query', $sp4e35b4); $sp5780b9 = json_decode($sp177bbf, true); if (!isset($sp5780b9['status'])) { Log::error('Pay.Meeol.verify Error: ' . $sp177bbf); } if ($sp5780b9['status'] === '0') { $spbc3979 = (int) round($sp5780b9['amount'] * 100); $spf8927a($sp5780b9['orderId'], $spbc3979, $sp5780b9['passTradeNo']); return true; } Log::debug('Pay.Meeol.verify debug, req:' . $sp4e35b4 . 'ret:' . $sp177bbf); return false; } else { throw new \Exception('请传递订单编号'); } } return false; } }