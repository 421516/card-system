<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spfc3b4d) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spfc3b4d; $this->url_return = SYS_URL . '/pay/return/' . $spfc3b4d; } function goPay($sp8abf69, $spbd054b, $sp547016, $speb838e, $sp6c12fc) { $spbd56f5 = sprintf('%.2f', $sp6c12fc / 100); $sp92f363 = $sp8abf69['id']; $sp55231a = $sp8abf69['key']; switch ($sp8abf69['payway']) { case 'alipay': $spdb2534 = 1; break; case 'qq': $spdb2534 = 2; break; case 'weixin': $spdb2534 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp1835de = array('id' => $sp92f363, 'pay_id' => $spbd054b, 'type' => $spdb2534, 'price' => $spbd56f5, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp1835de); $sp23eef6 = ''; $sp7a4fdc = ''; foreach ($sp1835de as $sp9684a3 => $spc28c86) { if ($spc28c86 == '' || $sp9684a3 == 'sign') { continue; } if ($sp23eef6 != '') { $sp23eef6 .= '&'; $sp7a4fdc .= '&'; } $sp23eef6 .= "{$sp9684a3}={$spc28c86}"; $sp7a4fdc .= "{$sp9684a3}=" . urlencode($spc28c86); } $sp3f78ce = $sp7a4fdc . '&sign=' . md5($sp23eef6 . $sp55231a); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $sp3f78ce); die; } function verify($sp8abf69, $spc98f69) { $spdcb97c = isset($sp8abf69['isNotify']) && $sp8abf69['isNotify']; $sp92f363 = $sp8abf69['id']; $sp55231a = $sp8abf69['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp23eef6 = ''; foreach ($_POST as $sp9684a3 => $spc28c86) { if ($spc28c86 == '' || $sp9684a3 == 'sign') { continue; } if ($sp23eef6) { $sp23eef6 .= '&'; } $sp23eef6 .= "{$sp9684a3}={$spc28c86}"; } if (!isset($_POST['pay_no']) || md5($sp23eef6 . $sp55231a) != $_POST['sign']) { if ($spdcb97c) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($spdcb97c) { echo 'fail'; } return false; } $spbd054b = $_POST['pay_id']; $sp0c4618 = intval((double) $_POST['price'] * 100); $sp2296f4 = $_POST['pay_no']; $spc98f69($spbd054b, $sp0c4618, $sp2296f4); if ($spdcb97c) { echo 'success'; } return true; } } }