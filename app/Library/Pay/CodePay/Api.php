<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp3a2be3) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp3a2be3; $this->url_return = SYS_URL . '/pay/return/' . $sp3a2be3; } function goPay($sp45b2a0, $spd184e1, $sp873da9, $sp33eb4d, $sp521b2c) { $sp983f6f = sprintf('%.2f', $sp521b2c / 100); $sp13c00e = $sp45b2a0['id']; $spcae82d = $sp45b2a0['key']; switch ($sp45b2a0['payway']) { case 'alipay': $sp0eab44 = 1; break; case 'qq': $sp0eab44 = 2; break; case 'weixin': $sp0eab44 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp38c5ae = array('id' => $sp13c00e, 'pay_id' => $spd184e1, 'type' => $sp0eab44, 'price' => $sp983f6f, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp38c5ae); $sp885ea3 = ''; $spe52f04 = ''; foreach ($sp38c5ae as $spa8a71b => $sp3172ba) { if ($sp3172ba == '' || $spa8a71b == 'sign') { continue; } if ($sp885ea3 != '') { $sp885ea3 .= '&'; $spe52f04 .= '&'; } $sp885ea3 .= "{$spa8a71b}={$sp3172ba}"; $spe52f04 .= "{$spa8a71b}=" . urlencode($sp3172ba); } $sp3eff46 = $spe52f04 . '&sign=' . md5($sp885ea3 . $spcae82d); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $sp3eff46); die; } function verify($sp45b2a0, $spf85c0e) { $sp5c8ce2 = isset($sp45b2a0['isNotify']) && $sp45b2a0['isNotify']; $sp13c00e = $sp45b2a0['id']; $spcae82d = $sp45b2a0['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp885ea3 = ''; foreach ($_POST as $spa8a71b => $sp3172ba) { if ($sp3172ba == '' || $spa8a71b == 'sign') { continue; } if ($sp885ea3) { $sp885ea3 .= '&'; } $sp885ea3 .= "{$spa8a71b}={$sp3172ba}"; } if (!isset($_POST['pay_no']) || md5($sp885ea3 . $spcae82d) != $_POST['sign']) { if ($sp5c8ce2) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($sp5c8ce2) { echo 'fail'; } return false; } $spd184e1 = $_POST['pay_id']; $sp07a665 = intval((double) $_POST['price'] * 100); $spe14c4a = $_POST['pay_no']; $spf85c0e($spd184e1, $sp07a665, $spe14c4a); if ($sp5c8ce2) { echo 'success'; } return true; } } }