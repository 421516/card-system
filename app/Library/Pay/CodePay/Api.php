<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($sp403bd7) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $sp403bd7; $this->url_return = SYS_URL . '/pay/return/' . $sp403bd7; } function goPay($sp4d5cc2, $sp2714cc, $spc644e5, $sp5b5e88, $sp9d9f48) { $sp6246a9 = sprintf('%.2f', $sp9d9f48 / 100); $spf3db97 = $sp4d5cc2['id']; $sp09dca8 = $sp4d5cc2['key']; switch ($sp4d5cc2['payway']) { case 'alipay': $sp9d3dc0 = 1; break; case 'qq': $sp9d3dc0 = 2; break; case 'weixin': $sp9d3dc0 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp151100 = array('id' => $spf3db97, 'pay_id' => $sp2714cc, 'type' => $sp9d3dc0, 'price' => $sp6246a9, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp151100); $sp26d1d6 = ''; $sp5e6f1a = ''; foreach ($sp151100 as $spfcd1b0 => $sp1f05d8) { if ($sp1f05d8 == '' || $spfcd1b0 == 'sign') { continue; } if ($sp26d1d6 != '') { $sp26d1d6 .= '&'; $sp5e6f1a .= '&'; } $sp26d1d6 .= "{$spfcd1b0}={$sp1f05d8}"; $sp5e6f1a .= "{$spfcd1b0}=" . urlencode($sp1f05d8); } $sp26c3c2 = $sp5e6f1a . '&sign=' . md5($sp26d1d6 . $sp09dca8); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $sp26c3c2); die; } function verify($sp4d5cc2, $spae1cf8) { $sp5c532f = isset($sp4d5cc2['isNotify']) && $sp4d5cc2['isNotify']; $spf3db97 = $sp4d5cc2['id']; $sp09dca8 = $sp4d5cc2['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp26d1d6 = ''; foreach ($_POST as $spfcd1b0 => $sp1f05d8) { if ($sp1f05d8 == '' || $spfcd1b0 == 'sign') { continue; } if ($sp26d1d6) { $sp26d1d6 .= '&'; } $sp26d1d6 .= "{$spfcd1b0}={$sp1f05d8}"; } if (!isset($_POST['pay_no']) || md5($sp26d1d6 . $sp09dca8) != $_POST['sign']) { if ($sp5c532f) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($sp5c532f) { echo 'fail'; } return false; } $sp2714cc = $_POST['pay_id']; $spe1a1d8 = intval((double) $_POST['price'] * 100); $spb306ab = $_POST['pay_no']; $spae1cf8($sp2714cc, $spe1a1d8, $spb306ab); if ($sp5c532f) { echo 'success'; } return true; } } }