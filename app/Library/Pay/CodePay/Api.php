<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spf46c5d) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spf46c5d; $this->url_return = SYS_URL . '/pay/return/' . $spf46c5d; } function goPay($spa9e109, $sp206d07, $sp89af34, $sp92f0c1, $sp28f24f) { $sp9a8a75 = sprintf('%.2f', $sp28f24f / 100); $spf6ef15 = $spa9e109['id']; $spa09e0e = $spa9e109['key']; switch ($spa9e109['payway']) { case 'alipay': $sp65e297 = 1; break; case 'qq': $sp65e297 = 2; break; case 'weixin': $sp65e297 = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp29e0c7 = array('id' => $spf6ef15, 'pay_id' => $sp206d07, 'type' => $sp65e297, 'price' => $sp9a8a75, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp29e0c7); $sp9c9a88 = ''; $spd1a4f6 = ''; foreach ($sp29e0c7 as $spf74fd0 => $sp5d0add) { if ($sp5d0add == '' || $spf74fd0 == 'sign') { continue; } if ($sp9c9a88 != '') { $sp9c9a88 .= '&'; $spd1a4f6 .= '&'; } $sp9c9a88 .= "{$spf74fd0}={$sp5d0add}"; $spd1a4f6 .= "{$spf74fd0}=" . urlencode($sp5d0add); } $spfed6d4 = $spd1a4f6 . '&sign=' . md5($sp9c9a88 . $spa09e0e); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $spfed6d4); die; } function verify($spa9e109, $spf8927a) { $spf53f48 = isset($spa9e109['isNotify']) && $spa9e109['isNotify']; $spf6ef15 = $spa9e109['id']; $spa09e0e = $spa9e109['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp9c9a88 = ''; foreach ($_POST as $spf74fd0 => $sp5d0add) { if ($sp5d0add == '' || $spf74fd0 == 'sign') { continue; } if ($sp9c9a88) { $sp9c9a88 .= '&'; } $sp9c9a88 .= "{$spf74fd0}={$sp5d0add}"; } if (!isset($_POST['pay_no']) || md5($sp9c9a88 . $spa09e0e) != $_POST['sign']) { if ($spf53f48) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($spf53f48) { echo 'fail'; } return false; } $sp206d07 = $_POST['pay_id']; $spbc3979 = (int) round($_POST['price'] * 100); $spe62189 = $_POST['pay_no']; $spf8927a($sp206d07, $spbc3979, $spe62189); if ($spf53f48) { echo 'success'; } return true; } } }