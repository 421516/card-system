<?php
namespace App\Library\Pay\Codepay; use App\Library\Pay\ApiInterface; use Illuminate\Support\Facades\Log; class Api implements ApiInterface { private $url_notify = ''; private $url_return = ''; public function __construct($spe6149b) { $this->url_notify = SYS_URL_API . '/pay/notify/' . $spe6149b; $this->url_return = SYS_URL . '/pay/return/' . $spe6149b; } function goPay($spd82bcd, $sp6281ad, $spe4243d, $sp1d246b, $sp54eead) { $sp90753f = sprintf('%.2f', $sp54eead / 100); $spe289ce = $spd82bcd['id']; $spf52c64 = $spd82bcd['key']; switch ($spd82bcd['payway']) { case 'alipay': $spcbde7f = 1; break; case 'qq': $spcbde7f = 2; break; case 'weixin': $spcbde7f = 3; break; default: throw new \Exception('支付方式填写错误, alipay/qq/weixin'); } $sp94131d = array('id' => $spe289ce, 'pay_id' => $sp6281ad, 'type' => $spcbde7f, 'price' => $sp90753f, 'param' => '', 'notify_url' => $this->url_notify, 'return_url' => $this->url_return); ksort($sp94131d); $sp36c1ea = ''; $sp5aa9e3 = ''; foreach ($sp94131d as $sp63ae76 => $sp679ba2) { if ($sp679ba2 == '' || $sp63ae76 == 'sign') { continue; } if ($sp36c1ea != '') { $sp36c1ea .= '&'; $sp5aa9e3 .= '&'; } $sp36c1ea .= "{$sp63ae76}={$sp679ba2}"; $sp5aa9e3 .= "{$sp63ae76}=" . urlencode($sp679ba2); } $spedc15a = $sp5aa9e3 . '&sign=' . md5($sp36c1ea . $spf52c64); var_dump('加载中'); header('Location: http://api2.fateqq.com:52888/creat_order/?' . $spedc15a); die; } function verify($spd82bcd, $spbb5f38) { $spe16bd1 = isset($spd82bcd['isNotify']) && $spd82bcd['isNotify']; $spe289ce = $spd82bcd['id']; $spf52c64 = $spd82bcd['key']; if (empty($_POST)) { $_POST = $_GET; } ksort($_POST); reset($_POST); $sp36c1ea = ''; foreach ($_POST as $sp63ae76 => $sp679ba2) { if ($sp679ba2 == '' || $sp63ae76 == 'sign') { continue; } if ($sp36c1ea) { $sp36c1ea .= '&'; } $sp36c1ea .= "{$sp63ae76}={$sp679ba2}"; } if (!isset($_POST['pay_no']) || md5($sp36c1ea . $spf52c64) != $_POST['sign']) { if ($spe16bd1) { echo 'fail'; } return false; } else { if (!isset($_POST['pay_id'])) { Log::error('CodePay.verify ERROR: there is no pay_id in $_POST', array('$_POST' => json_encode($_POST))); if ($spe16bd1) { echo 'fail'; } return false; } $sp6281ad = $_POST['pay_id']; $spf4aff4 = intval((double) $_POST['price'] * 100); $sp5b4f94 = $_POST['pay_no']; $spbb5f38($sp6281ad, $spf4aff4, $sp5b4f94); if ($spe16bd1) { echo 'success'; } return true; } } }